<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="木下英俊">
  <meta name="description" content="木下英俊が自身のためにプログラムメモを残すことを目的に作成したページです。">
  <meta name="keywords" content="">
  <!-- キャッシュ無効化 -->
  <meta http-equiv="Cache-Control" content="no-cache">
	
  <title>[VBA] ガントチャートツールを作る</title>

  <!-- CSS -->
  <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../design.css" type="text/css">
	
  <!-- Start for 'google-code-prettify' -->
  <link href="../prettify/styles/desert.css" rel="stylesheet" type="text/css">
  <script src="../prettify/prettify.js" type="text/javascript"></script>
  <script src="../prettify/lang-vb.js" type="text/javascript"></script>
  <!-- End for 'google-code-prettify' -->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V2DZQK54C2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-V2DZQK54C2');
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  
</head>

<body onload="prettyPrint();">

<h1>［Excel］Excelガントチャート を作る</h1>

<p> 「Excelガントチャート」を自作したので、以下でこのソフトウェアおよび作り方を紹介します。</p>
<p> 仕事でもいろいろとガントチャートツールを利用しました。が、少しずつ何かが足りませんでした。<br>私が強く求めるのは以下のような機能でした。</p>
<ol style="list-style-type: decimal; list-style-position: outside; margin-left: 0px;">
  <li>計画/実績 を記載できること。</li>
  <li>バーチャート（ガントチャート）を表示すること。またこの更新が楽であること。</li>
  <li>分解能は 1日 を基本とすること。</li>
  <li>関係者へ配布できること。（ライセンスが無料であること、と同意。この観点でExcelファイルが優れている）</li>
  <li>動作が軽快であること。（この観点では、MS Project、ProjectLibre などが秀逸。多くのExcelガントチャートはこれがNG。）</li>
  <li>少なくともWBSを100程度は記載できること。改ページ可。</li>
  <li>６カ月程度のスケジュールを一画面に記載できること。</li>
</ol>
<p> これらの要望を満足する&quot;Excelガントチャート&quot;の実現を目指します。</p>
<p> &nbsp;</p>
<p> &nbsp;</p>

<table style="border: 1px solid #808080; width: 100%; max-width:800px; background-color: #F0F0F0;">
  <tr>
    <td>
      <nav>
        <h2> 目次</h2>
        <p>
          <a href="#1._機能概要">1. 機能概要</a><br>
          <a href="#2._ベースのエクセルシートを作成_">2. ベースのエクセルシートを作成</a><br>
          <a href="#3._カレンダー部分を作る">3. カレンダー部分を作る</a><br>
          <a href="#4._設定１_を作る">4. 設定１ を作る</a><br>
          <a href="#5._ガントチャート(図)を描画">5. ガントチャート(図)を描画</a><br>
          <a href="#6._描画済みガントチャート(図)を全削除">6. 描画済みガントチャート(図)を全削除</a><br>
          <a href="#7._独自のコンテキストメニューを追加">7. 独自のコンテキストメニューを追加</a><br>
          <a href="#8._ワークブック終了処理、デアクティブ時の処理">8. ワークブック終了処理、デアクティブ時の処理</a><br>
          <a href="#9._設定２_を作る">9. 設定２ を作る</a><br><br>
          <a href="#サンプルプログラム">サンプルプログラム</a><br><a href="#ライセンス">ライセンス</a><br>
          <a href="#参考">参考</a>
        </p>
      </nav>
    </td>
  </tr>
</table>


<p> &nbsp;</p>

<section>
  <h2> <a name="1._機能概要">1. 機能概要</a></h2>
  <p> こんな感じの「Excelガントチャート」ツールを作っていきます。</p>
<p> &nbsp;</p>

<p>[紹介ビデオ]</p>
  
  <video controls autoplay="y" loop="y" src="gantchart/Introduction_video.mp4">
    <p>動画を再生するには &lt;video&gt; タグをサポートしたブラウザが必要です。</p>
  </video>
  
<p> &nbsp;</p>
<p> &nbsp;</p>
  <p> 図．全体図</p>
  <p> <img alt="" height="680" src="gantchart/imgA.jpg" width="1336"></p>
  <p> &nbsp;</p>
  <p> 図．スケジュール更新をコンテキストメニューから行う様子</p>
  <p> <img alt="" src="gantchart/img11.jpg"></p>
  <p> &nbsp;</p>
  <p> 図．設定１</p>
  <p> <img alt="" src="gantchart/imgB1.jpg"></p>
  <p> &nbsp;</p>
  <p> 図．設定２</p>
  <p> <img alt="" src="gantchart/imgC.jpg"></p>
  <p> &nbsp;</p>
  <p> 図．注意事項など</p>
  <p> <img alt="" src="gantchart/imgE1.jpg"></p>
  
  <p>&nbsp;</p>
  <p>&nbsp;</p>

</section>


<section>
  <h2> <a name="2._ベースのエクセルシートを作成_">2. ベースのエクセルシートを作成</a></h2>
</section>
  <h4>[概要]</h4>
  <p> VBA 無しで、まずはベース部分を作ってみます。</p>
<p> 要求事項はこんな感じで。</p>
<ol style="list-style-type: decimal; list-style-position: outside; margin-left: 0px;">
  <li>「計画」と「実績」を分けて記載できるようにする。</li>
  <li>分解能を 1日 とする。</li>
  <li>WBSを100とする。</li>
  <li>6カ月程度のスケジュールとする。</li>
  <li>「担当者」欄を設ける。</li>
  <li>「ステータス」欄を設ける。</li>
</ol>
<p> カレンダーの月、日の部分は一旦空欄にしておきます。ここは次の章で作っていきます。</p>
<p> &nbsp;</p>
<p> ここでは下図のような感じでレイアウトを作ってみました。</p>
<p> 「カテゴリ」はグルーピングなどを意識した項目です。「大分類」「中分類」など複数列にしても良いかもしれません。</p>
<p> &nbsp;</p>
<p> <img alt="" src="gantchart/img19.jpg"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<p> サンプル： <a href="gantchart/Excel_gantchart_chap-02.xlsm">ダウンロード</a></p>
<p> &nbsp;</p>
  
  <p>&nbsp;</p>


<section>


<section>
  <h2> <a name="3._カレンダー部分を作る">3. カレンダー部分を作る</a></h2>
  <h4>[概要]</h4>
  <p> 引き続き VBA 無しで、条件付き書式、excelのセルへの関数指定、などでさらにベース部分を作りこみしてみます。</p>
<p> &nbsp;</p>
<h3> 3-1. 「開始日」を指定でカレンダーを更新</h3>
<p> 最初に日を表示する部分の書式を変更します。<br>&quot;セルの表示設定&quot; を &quot;日のみ&quot;(d) にします。&quot;=date(Y1)&quot; 
とすることでも同じことをできますが、後で示す曜日の実現でこのセルには年月日の全ての情報を持っていてほしいので、表示形式で&quot;日のみ&quot;の表示を実現します。</p>
<p> <img alt="" src="gantchart/imgC1.jpg"></p>
<p> &nbsp;</p>
<p> 続いて、カレンダーの最も左側の日付を「開始日」と同じ日にします。</p>
<p> それ以降の日を、一つ左側のセルの翌日とします。</p>
<p> 左側から２つ目のセルを設定したらドラッグでOKです。</p>
<p> <img alt="" src="gantchart/img8.jpg"></p>
<p> &nbsp;</p>
<p> <img alt="" src="gantchart/img9.jpg"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h3> 3-2. 月を表示</h3>
<p> 次に月の部分を作ります。</p>
<p> 月表示は以下の条件で行います。</p>
<p>・最も左側のセルは月を表示</p>
<p>・各月の１日に対応するセルは月を表示</p>
<p>・以上の条件以外、空欄</p>
<p> &nbsp;</p>
<p> &quot;セルの書式設定&quot; を &quot;月のみ&quot;(m)とします。</p>
<p> <img alt="" src="gantchart/img10.jpg"></p>
<p> &nbsp;</p>
<p> 一番左側のセルは、真下と同じ日付を代入、月をそのまま無条件で表示します。</p>
<p> <img alt="" src="gantchart/img12.jpg"></p>
<p> &nbsp;</p>
<p> それ以外のセルは、参照するセルを各セルの真下として、日付が１のときだけ日付を代入し、それ以外は空欄を代入します。</p>
<p> <img alt="" src="gantchart/img14.jpg"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h3> 3-3. 曜日を表示</h3>
<p> 次に曜日表示です。こちらは全部のセルが同じ手順です。</p>
<p> 真上のセルを参照し、「=TEXT(AH5, &quot;AAA&quot;)」という式で曜日を計算して表示してくれます。</p>
<p> <img alt="" src="gantchart/img16.jpg"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h3> 3-4. 月の部分は 1日なら左側に縦罫線、翌日が&quot;END&quot;なら右側に縦罫線</h3>
<p> 今のままでは月の切り替わり部分、最終セルの右側、に罫線がありません。</p>
<p> 美しくないので、ここに罫線を自動追加されるように &quot;条件付き書式&quot; を設定します。</p>
<p> &nbsp;</p>
<p> <img alt="" src="gantchart/img1D.jpg"> <img alt="" src="gantchart/img1E.jpg"></p>
<p> &nbsp;</p>
<p> 月部分の全セルを選択後、&quot;条件付き書式&quot;を設定します。</p>
<p> <img alt="" src="gantchart/img21.jpg"></p>
<p> <img alt="" src="gantchart/img22.jpg"></p>
<p> &nbsp;</p>
<p> <img alt="" src="gantchart/img23.jpg"></p>
<p> &nbsp;</p>
<p> これで月の切り替わりに罫線が入りました。</p>
<p> <img alt="" src="gantchart/img24.jpg"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<p> 同様に、最終列に罫線を加える作業をします。最終列のセルに &quot;END&quot; という表記を入れてこれをマークにして書式指定します。</p>
<p> <img alt="" src="gantchart/img26.jpg"></p>
<p> &nbsp;</p>
<p> この場合は右側に縦の罫線を追加します。</p>
<p> <img alt="" src="gantchart/img27.jpg"></p>
<p> &nbsp;</p>
<p> こういう書式設定を行いました。</p>
<p> <img alt="" src="gantchart/img29.jpg"></p>
<p> &nbsp;</p>
<p> 最終列にも罫線が入りました。</p>
<p> <img alt="" src="gantchart/img2A.jpg"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h3> 3-5. カレンダーの土日を別の色にする</h3>
  <p> &nbsp;</p>
  <p> こちらも条件付き書式を使って実現します。こちら比較的簡単なのでラフに記載します。</p>
  <p> &nbsp;</p>
  <p> 1. 条件付き書式で新しいルールを作成します。</p>
  <p> 色付けする範囲を選択後、条件付き書式から「新しいルール」を選択します。</p>
  <p> <img alt="" src="gantchart/img6.jpg"></p>
  <p> &nbsp;</p>
  <p> 2. ルールは「数式を使用して、書式設定をするセルを決定」とし、ルールを下図のように設定します。</p>
  <p> 5 の方のみを"$"で指定します。AHに"$"を付けてはいけません。</p>
  <blockquote>
    =TEXT(AH$5,"aaa")="土"</blockquote>
  <p> TEXT 関数で "aaa" の指定は曜日表記のところでも使用しました。便利なのでぜひ覚えていただきたいです。</p>
  <p> セルの色は［書式(F)...］から水色を設定しました。</p>
  <p> &nbsp;</p>
  <p> <img alt="" src="gantchart/img4.jpg"></p>
  <p> &nbsp;</p>
  <p> 3. 「条件付き書式ルールの管理」から状態を確認すると、下図のようになっているはずです。</p>
  <p> 書式ルールの表示として「このワークシート」を選択してください。</p>
  <p> 適用先を色を付ける全ての範囲として、下図では、"$AH$5:$H$106" を設定できています。</p>
  <p> <img alt="" src="gantchart/img3.jpg"></p>
<p> &nbsp;</p>
  <p> 4. 同様に日曜日も同じ手順で進めます。</p>
  <p> 書式設定の部分で "土" を "日" へ変更するだけなので、説明は割愛します。</p>
  <p> &nbsp;</p>
<p> &nbsp;</p>
<p> サンプル： <a href="gantchart/Excel_gantchart_chap-03.xlsm">ダウンロード</a></p>
<p> &nbsp;</p>
  
  <p> &nbsp;</p>
<p> &nbsp;</p>
</section>
  <h2> <a name="4._設定１_を作る">4. 設定１ を作る</a></h2>
  <h4>[概要]</h4>
  <p> 引き続き VBA 無しで、条件付き書式、excelのセルへの関数指定、などでさらにベース部分を作りこみしてみます。</p>
<p> &nbsp;</p>
<h3> 4-1. 「担当」を選べるようにする</h3>
<p> &nbsp;</p>
<h3> 4-2. 「ステータス」を選べるようにする</h3>
<h3> &nbsp;</h3>
<h3> 4-3. ステータスを「WBS終了条件」にしたら、行をグレー化する</h3>
<p> &nbsp;</p>
<h3> 4-4. カレンダーの色表示を祝日対応する</h3>
  <p> 土曜日、日曜日に色付けする方法とほとんど同じです。こちらも条件付き書式を使って実現します。</p>
  <p> &nbsp;</p>
  <p> 1. 「設定１」シートに祝日とする年月日一覧を準備します。</p>
  <p> <img alt="" src="gantchart/imgB.jpg"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> 2. 条件付き書式で新しいルールを作成します。</p>
  <p> 色付けする範囲を選択後、条件付き書式から「新しいルール」を選択します。</p>
  <p> <img alt="" src="gantchart/img6.jpg"></p>
  <p> &nbsp;</p>
  <p> 2. ルールは「数式を使用して、書式設定をするセルを決定」とし、ルールを下図のように設定します。</p>
  <p> "AH$5" の部分について、5 の方のみを"$"で指定します。AHに"$"を付けてはいけません。</p>
  <p> 祝日との一致確認の方法として、ここでは COUNTIF 関数を使っています。</p>
  <blockquote>
    =COUNTIF(設定1!$E$3:$E$311,AH$5)&gt;=1</blockquote>
  <p> セルの色は［書式(F)...］からオレンジ色を設定しました。</p>
  <p> <img alt="" src="gantchart/imgA1.jpg"></p>
  <p> &nbsp;</p>
  <p> 3. 「条件付き書式ルールの管理」から状態を確認すると、下図のようになっているはずです。</p>
  <p> 書式ルールの表示として「このワークシート」を選択してください。</p>
  <p> 適用先を色を付ける全ての範囲として、下図では、"$AH$5:$H$106" を設定できています。</p>
  <p> <img alt="" src="gantchart/imgE.jpg"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <hr>
  <p> &nbsp;</p>
<p> &nbsp;</p>
<h2> <a name="5._ガントチャート(図)を描画">5. ガントチャート(図)を描画</a></h2>
  <h4>[概要]</h4>
  <p> 計画、実績 の期間を入力したら、その内容に従ってガントチャート（図）を作図する処理を追加します。</p>
<p> VBA を使います。</p>
  <p> &nbsp;</p>
  <p> 1.</p>
  <p> まずは基本的な部分から。</p>
  <p> 線を描画するには Shapes.AddLine という関数を使用することでできるようです。<br>
  そのまま直接使ってもよさそうですが、複数個所で使用しそうな気がするので、あとで一括して変更することを想定して標準モジュール内で関数化しました。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    線を引く
'
' 引数：    sheet       線を引くシート
'           beginX      線の起点 X
'           endX        線の起点 Y
'           beginY      線の終点 X
'           endY        線の終点 Y
' 戻値：    shape       引いた線
Function drawLine(sheet As Worksheet, beginX As Long, beginY As Long, endX As Long, endY As Long) As shape
    Set drawLine = sheet.Shapes.AddLine(beginX, beginY, endX, endY)
End Function</pre>
  <p> &nbsp;</p>
  <p> 2.</p>
  <p> 計画の線を引く、実績の線を引く、という２つの関数を作成します。</p>
  <p> 開始と終了のセルを指定することでその間に線を描画する、という内容です。</p>
  <p> ガントチャートシートのVBAとして記載します。</p>
  <pre class="prettyprint linenums lang-vb">
Private Const START_DATE_RANGE = 34
Private Const START_WBS = 7
Private Const GANTCHART_SHEET_NAME = "ガントチャート（6か月）"
Private Const SETTING_SHEET_1_NAME = "設定1"
Private Const SETTING_SHEET_2_NAME = "設定2"
Private Const NAME_KEIKAKU = "keikaku_"
Private Const NAME_JISSEKI = "jisseki_"


'
' 概要：    計画の線を一本引く
'
Private Function 計画の線を引く(startCell As Range, endCell As Range) As shape
    Dim thisShape As shape
    Set thisShape = drawLine(ThisWorkbook.ActiveSheet, startCell.Left + 2, startCell.Top + startCell.Height / 4, endCell.Left + endCell.Width, endCell.Top + endCell.Height / 4)
    With thisShape.Line
        .DashStyle = msoLineSolid
        .ForeColor.ObjectThemeColor = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME).Range("D3")
        .ForeColor.TintAndShade = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME).Range("D4")
        .Weight = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME).Range("D5")
        
    End With
    
    thisShape.name = NAME_KEIKAKU &amp; startCell.Row
    
    Set 計画の線を引く = thisShape
End Function


'
' 概要：    実績の線を一本引く
'
Private Function 実績の線を引く(startCell As Range, endCell As Range) As shape
    Dim thisShape As shape
    Dim settingSheet As Worksheet
    
    Set settingSheet = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME)
    
    Set thisShape = drawLine(ThisWorkbook.ActiveSheet, startCell.Left + 2, startCell.Top + startCell.Height * 3 / 4, endCell.Left + endCell.Width, endCell.Top + endCell.Height * 3 / 4)
    
    With thisShape.Line
        .DashStyle = msoLineSolid
        .ForeColor.ObjectThemeColor = settingSheet.Range("D6")
        .ForeColor.TintAndShade = settingSheet.Range("D7")
        .Weight = settingSheet.Range("D8")
        
        .BeginArrowheadStyle = msoArrowheadOpen
        .BeginArrowheadLength = msoArrowheadShort
        .BeginArrowheadWidth = msoArrowheadNarrow
        .BeginArrowheadLength = settingSheet.Range("D9").Value   ' msoArrowheadShort
        .BeginArrowheadWidth = settingSheet.Range("D10").Value   ' msoArrowheadNarrow
        
        .EndArrowheadStyle = msoArrowheadOpen
        .EndArrowheadLength = msoArrowheadShort
        .EndArrowheadWidth = msoArrowheadNarrow
        .EndArrowheadLength = settingSheet.Range("D11").Value    ' msoArrowheadShort
        .EndArrowheadWidth = settingSheet.Range("D12").Value     ' msoArrowheadNarrow
        
    End With
    
    thisShape.name = NAME_JISSEKI &amp; startCell.Row
    
    Set 実績の線を引く = thisShape
    
End Function</pre>
  <p> &nbsp;</p>
  <p> 3.</p>
  <p> ガントチャート全体を更新する関数（UpdateGantchar()）を作成します。</p>
  <p> 「線を一括削除する」関数の部分は後程。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    シート上の線(Line)を全て消す
'
Public Sub deleteAllLines()
    Call 線を一括削除する(ThisWorkbook.Sheets(GANTCHART_SHEET_NAME))
End Sub


'
' 概要：    ガントチャート表示を更新する
'
Public Sub UpdateGantchart()
    Dim thisShape As shape
    Dim keikaku_start As Long
    Dim keikaku_end As Long
    Dim jisseki_start As Long
    Dim jisseki_end As Long
    
    Dim retStart As Long
    Dim retEnd As Long
    
            
    ' 全てのラインを消す
    Call deleteAllLines
    
    Dim i As Long
    For i = START_WBS To getMaxRow(ThisWorkbook.ActiveSheet, 1)
    
        ' 計画を描画
        If Cells(i, "V").Value &lt;&gt; "" And Cells(i, "Y") &lt;&gt; "" Then
        
            retStart = SearchDate(Cells(i, "V"))
            If retStart &lt;&gt; -1 Then
                keikaku_start = retStart
            Else
                keikaku_start = START_DATE_RANGE
            End If
            
            retEnd = SearchDate(Cells(i, "Y"))
            If retEnd &lt;&gt; -1 Then
                keikaku_end = retEnd
            Else
                keikaku_end = getMaxCol(ThisWorkbook.ActiveSheet, 1)
            End If
            
            If (GetEndDate() - CDate(Cells(i, "V").Value) &gt;= 0) And (CDate(Cells(i, "Y")) - GetStartDate() &gt;= 0) Then
                Set thisShape = 計画の線を引く(Cells(i, keikaku_start), Cells(i, keikaku_end))
            End If
        End If
        
        ' 実績を描画
        If Cells(i, "AB") &lt;&gt; "" And Cells(i, "AE") Then
            retStart = SearchDate(Cells(i, "AB"))
            If retStart = -1 Then
                jisseki_start = START_DATE_RANGE
            Else
                jisseki_start = retStart
            End If
            
            retEnd = SearchDate(Cells(i, "AE"))
            If retEnd = -1 Then
                jisseki_end = getMaxCol(ThisWorkbook.ActiveSheet, 1)
            Else
                jisseki_end = retEnd
            End If
            
            If (GetEndDate() - CDate(Cells(i, "AB").Value) &gt;= 0) And (CDate(Cells(i, "AE")) - GetStartDate() &gt;= 0) Then
                Set thisShape = 実績の線を引く(Cells(i, jisseki_start), Cells(i, jisseki_end))
                
                If retStart = -1 Then
                    With thisShape.Line
                        .BeginArrowheadStyle = msoArrowheadNone
                    End With
                End If
                
                If retEnd = -1 Then
                    With thisShape.Line
                        .EndArrowheadStyle = msoArrowheadNone
                    End With
                End If
            End If
        End If
    Next i
End Sub</pre>
  <p> &nbsp;</p>
  <p> 下記部分について補足です。<br>ここは実績の線を引くときに、開始日や終了日がカレンダー範囲外であるときに矢印の形状を変更しています。</p>
  <p> 具体的には、例えば → を － へ変更することで終端でないことを表現しています。</p>
  <pre class="prettyprint linenums lang-vb">
            If (GetEndDate() - CDate(Cells(i, "AB").Value) &gt;= 0) And (CDate(Cells(i, "AE")) - GetStartDate() &gt;= 0) Then
                Set thisShape = 実績の線を引く(Cells(i, jisseki_start), Cells(i, jisseki_end))
                
                If retStart = -1 Then
                    With thisShape.Line
                        .BeginArrowheadStyle = msoArrowheadNone
                    End With
                End If
                
                If retEnd = -1 Then
                    With thisShape.Line
                        .EndArrowheadStyle = msoArrowheadNone
                    End With
                End If
            End If</pre>
  <p> &nbsp;</p>
  <p> 4.</p>
  <p> 上記関数を呼ぶためのトリガーとして、セルの値が更新されたときにガントチャート更新を実施するように Worksheet_Change() 
  関数を設定します。</p>
  <p> 具体的には、計画および実績の開始日・終了日を変更することでバーチャートが更新されるイメージです。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    セルに変化があった時のイベント処理
'
' 著作：    木下英俊
' 履歴：
'           2020-07-08 新規作成
'
Private Sub Worksheet_Change(ByVal Target As Range)
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    
    ' レイアウト更新
    Call UpdateLayout
    
    ' ナンバリングを更新
    'Call UpdateNumbering
    Call UpdateNumbering2
    
    ' ガントチャートを更新
    Call UpdateGantchart
    
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub</pre>
  <p> &nbsp;</p>
  <hr>
<p> &nbsp;</p>
<h2> <a name="6._描画済みガントチャート(図)を全削除">6. 描画済みガントチャート(図)を全削除</a></h2>
  <h4>[概要]</h4>
  <p> 描画済みのガントチャート(図)を全て削除する処理を追加します。画面更新するためには、一旦すべての表示済みの線を削除する必要があります。</p>
  <p> &nbsp;</p>
  <p> 
  「線を一括削除する」という関数を作成します。汎用性を考えて標準モジュールとして作成しています。これに伴って引数として対象のシートを渡す必要があります。</p>
<p> また、ガントチャート以外の図は消さないようにします。これを行わないとメモなどの図やテキストもすべて削除されてしまうので不便です。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    線を一括削除する
'
' 引数：    sheet       処理対象のシート
'
' 著作：    木下 英俊
' 履歴：    2020-07-07  新規作成
' 補足：    Excel画面から手動で描画した線の Type は "msoAutoShape" になって区別できるようです。
'           "msoAutoShape" の値は 1 です。
' 参考：    https://docs.microsoft.com/ja-jp/office/vba/api/office.msoshapetype
'
Sub 線を一括削除する(sheet As Worksheet)
  Dim shp As shape
  For Each shp In sheet.Shapes
    If shp.Type = msoLine Then
        shp.Delete
    End If
  Next shp
End Sub</pre>
  <p> &nbsp;</p>
  <p> このプログラム中で描画する線は Type = msoLine (9) となります。</p>
  <p> ちなみに Excel で通常描画する線の Type を確認してみたら msoAutoShape (1) でした。<br>
  このため上記プログラムで線を削除するとガントチャートで自動作成した線のみを削除できます。手動で描いた線は残るので便利で良い感じになりました。</p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
<p> &nbsp;</p>
<h2> <a name="7._独自のコンテキストメニューを追加">7. 独自のコンテキストメニューを追加</a></h2>
  <h4>[概要]</h4>
  <p> 独自の右クリックメニュー(コンテキストメニュー)を追加する方法を示します。</p>
<p> 右クリックメニューとして「計画を設定」「実績を設定」を追加します。</p>
<p> 合わせて、これらメニューを選択したときに対応する計画および実績のセルを更新します。</p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h2> <a name="8._ワークブック終了処理、デアクティブ時の処理">8. ワークブック終了処理、デアクティブ時の処理</a></h2>
  <h4>[概要]</h4>
  <p> エクセルワークブックを閉じる際の後処理を実装します。</p>
<p> ・独自のコンテキストメニューを削除します。</p>
<p> &nbsp;</p>
<p> 同様に、別のエクセルブックを使用するなどによりデアクティブになった際の処理を実装します。</p>
<p> ・独自のコンテキストメニューを削除します。</p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h2> <a name="9._設定２_を作る">9. 設定２ を作る</a></h2>
<h3> 9-1. 線の色を変える (ObjectThemeColor)</h3>
<p> &nbsp;</p>
<h3> 9-2. 線の色を変える (TintAndShade)</h3>
<p> &nbsp;</p>
<h3> 9-3. 線の太さを変える(Weight)</h3>
<p> &nbsp;</p>
<p> &nbsp;</p>
  <hr>
  <p> &nbsp;</p>
  
</section>
<section>
  <h2><a name="サンプルプログラム">サンプルプログラム</a></h2>
  <p>
  以上の内容を全て（＋アルファ？）した <strong>Excelガントチャート</strong> を以下からダウンロードできます。<br>
  私自身が業務で使用することを目的にこれをブラッシュアップしているので、ここのが一番完成度が高いです。</p>
<p>
  使用ライセンスはエクセルシートに記載の通り &quot;木下が使用を許可した人だけ&quot; としています。要相談にて、ご連絡ください。</p>
<p>
  VBA についてはパスワードをかけていますが、ここのサイトを見れている人は以上の記事を参考に自分で作れますよね。</p>
<p>
  &nbsp;</p>
<p>
  サンプルプログラム <a href="gantchart/Excel_gantchart_v1_02.xlsm">ダウンロード</a></p>
  <br>
  
  <h4>変更履歴</h4>
  <table>
    <tr>
      <td class="td_history_date">2020-12-24</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.02</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">[Bug-fix] 他のExcelシートのコンテキストメニューにこのガントチャートのオリジナルメニューが表示される場合がある、という不具合を修正。</td>
    </tr>
    <tr>
      <td class="td_history_date">2020-07-09</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.01</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">祝日や任意の休みの表示に対応</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">１行または複数の行を切り取って別の場所へ挿入すると番号が崩れる、という課題を修正</td>
    </tr>
    <tr>
      <td class="td_history_date">2020-07-07</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.00</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">新規作成</td>
    </tr>
  </table>
</section>


<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>

<section>
  <h2><a name="ライセンス">ライセンス</a></h2>
<p>本ページの情報は、特記無い限り下記 MIT ライセンスで提供されます。</p>
<table class="border-collapse" style="width: 600px; background-color: #F0F0F0; word-break: break-word;">
  <tr>
    <td>
MIT License<br><br>

Copyright (c) 2020-2022  Kinoshita Hidetoshi<br><br>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:<br><br>

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.<br><br>

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
    </td>
  </tr>
</table>
  <p>&nbsp;</p>
</section>

<p>&nbsp;</p>


<section>
  <h2><a name="参考">参考</a></h2>
  <ul>
  	<li>bizroute － ガントチャートのエクセルテンプレート<br>
  	<a href="https://bizroute.net/download/gantchart_simple01" target="_blank">
  	https://bizroute.net/download/gantchart_simple01</a></li>
  	<li>[Excel]VBAで「右クリックメニュー」を追加する<br>
  	<a href="https://m0ratorium.com/vba-rightclickmenuadd/" target="_blank">
  	https://m0ratorium.com/vba-rightclickmenuadd/</a></li>
  	<li>Shape プロパティ (Excel)<br>
  	<a href="https://docs.microsoft.com/ja-jp/office/vba/api/excel.shape.line" target="_blank">
  	https://docs.microsoft.com/ja-jp/office/vba/api/excel.shape.line</a></li>
  	<li>特定のオブジェクトを削除する<br>
  	<a href="http://www4.synapse.ne.jp/yone/excel2010/excel2010_zu_obje_del.html" target="_blank">
  	http://www4.synapse.ne.jp/yone/excel2010/excel2010_zu_obje_del.html</a></li>
  	<li>右クリックメニューやサブメニューにマクロを登録／削除するには<br>
  	<a href="https://www.atmarkit.co.jp/ait/articles/1408/25/news030.html" target="_blank">
  	https://www.atmarkit.co.jp/ait/articles/1408/25/news030.html</a></li>
  	<li>【VBA】選択したセルを取得する『Selectionプロパティ』の使い方<br>
  	<a href="https://detail-infomation.com/vba-selection/" target="_blank">
  	https://detail-infomation.com/vba-selection/</a></li>
  	<li>Excel VBAで外部ファイルのモジュールを読み込み実行する方法<br>
  	<a href="https://eijiman.com/execute-external-file-module-excel-vba/" target="_blank">
  	https://eijiman.com/execute-external-file-module-excel-vba/</a></li>
    <li>MsoShapeType 列挙 (Office) | Microsoft Docs<br>
    <a href="https://docs.microsoft.com/ja-jp/office/vba/api/office.msoshapetype" target="_blank">
    https://docs.microsoft.com/ja-jp/office/vba/api/office.msoshapetype</a></li>
  </ul>
</section>


<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h2 style="margin-bottom:5px">記載</h2>
<table>

  <tr>
    <td class="td_history_date">2022-05-18</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">５章、６章を追記</td>
  </tr>

  <tr>
    <td class="td_history_date">&nbsp;</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">土日、祝日の色付けについて追記<br>
    </td>
  </tr>

  <tr>
    <td class="td_history_date">&nbsp;</td>
    <td class="td_history_separator">&nbsp;</td>
    <td class="td_history">(ここを読んでくれる読者が若干名いるようなので少しがんばってみました。VBAの記述も少しずつ足してみたいです。)</td>
  </tr>

  <tr>
    <td class="td_history_date">2021-09-05</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">紹介ビデオを追加</td>
  </tr>

  <tr>
    <td class="td_history_date">&nbsp;</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">目次体裁を最新フォーマットへ更新</td>
  </tr>

  <tr>
    <td class="td_history_date">2021-01-04</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">記事本文を更新</td>
  </tr>
  
  <tr>
    <td class="td_history_date">2020-12-24</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">サンプルプログラムを v1.02 へバージョンアップ</td>
  </tr>
  
  <tr>
    <td class="td_history_date">2020-07-11</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">サンプルプログラムを v1.01 へバージョンアップ</td>
  </tr>
  
  <tr>
    <td class="td_history_date">2020-07-07</td>
    <td class="td_history_separator">-</td>
    <td class="td_history">新規作成 </td>
  </tr>
  
</table>

<p>&nbsp;</p>

<footer>
<p><small>&copy; copyright 2020-2022 木下英俊</small></p>
</footer>

<p>&nbsp;</p>
</body>
</html>
