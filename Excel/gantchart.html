<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="木下英俊">
  <meta name="description" content="木下英俊が自身のためにプログラムメモを残すことを目的に作成したページです。">
  <meta name="keywords" content="">
  <!-- キャッシュ無効化 -->
  <meta http-equiv="Cache-Control" content="no-cache">
	
	<!-- タイトル -->
  <title>[VBA] ガントチャートツールを作る</title>

  <!-- ファビコン -->
  <link rel="shortcut icon" href="../favicon.ico">

  <!-- CSS -->
  <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../design.css" type="text/css">
	
  <!-- Start for 'google-code-prettify' -->
  <link href="../prettify/styles/desert.css" rel="stylesheet" type="text/css">
  <script src="../prettify/prettify.js" type="text/javascript"></script>
  <script src="../prettify/lang-vb.js" type="text/javascript"></script>
  <!-- End for 'google-code-prettify' -->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V2DZQK54C2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-V2DZQK54C2');
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  
  <style type="text/css">
    .auto-style1 {
      text-decoration: underline;
    }
  </style>
  
</head>

<body onload="prettyPrint();">

<h1>[Excel VBA] Excelガントチャート を作る</h1>

<p> 「Excelガントチャート」を自作したので、以下でこのソフトウェアおよび作り方を紹介します。</p>
<p> 仕事でもいろいろとガントチャートツールを利用しました。が、少しずつ何かが足りませんでした。<br>私が強く求めるのは以下のような機能でした。</p>
<ol style="list-style-type: decimal; list-style-position: outside; margin-left: 0px;">
  <li>計画/実績 を記載できること。</li>
  <li>バーチャート（ガントチャート）を表示すること。またこの更新が楽であること。</li>
  <li>分解能は 1日 を基本とすること。</li>
  <li>関係者へ配布できること。（ライセンスが無料であること、と同意。この観点でExcelファイルが優れている）</li>
  <li>動作が軽快であること。（この観点では、MS Project、ProjectLibre などが秀逸。多くのExcelガントチャートはこれがNG。）</li>
  <li>少なくともWBSを100程度は記載できること。改ページ可。</li>
  <li>６カ月程度のスケジュールを一画面に記載できること。</li>
</ol>
<p> これらの要望を満足する&quot;Excelガントチャート&quot;の実現を目指します。</p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<div class="mokuji">
  <nav>
	<h2>目次</h2>
  <p><a href="#1._機能概要">1. 機能概要</a></p>
  <p><a href="#2._ベースのエクセルシートを作成_">2. ベースのエクセルシートを作成</a></p>
  <p><a href="#3._カレンダー部分を作る">3. カレンダー部分を作る</a></p>
  <p><a href="#4._設定１_を作る">4. 設定１ を作る</a></p>
  <p><a href="#5._ガントチャート(図)を描画">5. ガントチャート(図)を描画</a></p>
  <p><a href="#6._描画済みガントチャート(図)を全削除">6. 描画済みガントチャート(図)を全削除</a></p>
  <p><a href="#7._独自のコンテキストメニューを追加">7. 独自のコンテキストメニューを追加</a></p>
  <p><a href="#8._ワークブック終了処理、デアクティブ時の処理">8. ワークブック終了処理、デアクティブ時の処理</a></p>
  <p><a href="#9._設定２_を作る">9. 設定２ を作る</a></p>
  <p><a href="#10._既知の問題">10. 既知の問題</a></p>
  <br>
  <p><a href="#サンプルプログラム">サンプルプログラム</a></p>
  <p><a href="#ライセンス">ライセンス</a></p>
  <p><a href="#参考">参考</a></p>
  </nav>
</div>

<p> &nbsp;</p>
<p> &nbsp;</p>

<section>
  <h2> <a name="1._機能概要">1. 機能概要</a></h2>
  <p> こんな感じの「Excelガントチャート」ツールを作っていきます。</p>

  <p> &nbsp;</p>

  <p>[紹介ビデオ]</p>  
  <video controls muted autoplay="y" loop="y" src="gantchart/Introduction_video.mp4" style="width: 1000px">
    <p>動画を再生するには &lt;video&gt; タグをサポートしたブラウザが必要です。</p>
  </video>
  
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> 図．全体図</p>
  <p> <img alt="ガントチャートイメージ" height="680" src="gantchart/imgA.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> 図．スケジュール更新をコンテキストメニューから行う様子</p>
  <p> <img alt="メニュー例" src="gantchart/img11.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> 図．設定１</p>
  <p> <img alt="設定１" class="border" src="gantchart/img25.jpg" width="800"></p>
  <p> &nbsp;</p>
  <p> 図．設定２</p>
  <p> <img alt="設定２" src="gantchart/imgC.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p>&nbsp;</p>

</section>


<section>
  <h2> <a name="2._ベースのエクセルシートを作成_">2. ベースのエクセルシートを作成</a></h2>
  <h4>[概要]</h4>
  <p> VBA 無しで、まずはベース部分を作ってみます。</p>
  <p> 要求事項はこんな感じで。</p>
  <ol style="list-style-type: decimal; list-style-position: outside; margin-left: 0px;">
    <li>「計画」と「実績」を分けて記載できるようにする。</li>
    <li>分解能を 1日 とする。</li>
    <li>WBSを100とする。</li>
    <li>6カ月程度のスケジュールとする。</li>
    <li>「担当者」欄を設ける。</li>
    <li>「ステータス」欄を設ける。</li>
  </ol>
  <p> カレンダーの月、日の部分は一旦空欄にしておきます。ここは次の章で作っていきます。</p>
  <p> &nbsp;</p>
  <p> ここでは下図のような感じでレイアウトを作ってみました。</p>
  <p> 「カテゴリ」はグルーピングなどを意識した項目です。「大分類」「中分類」など複数列にしても良いかもしれません。</p>
  <p> &nbsp;</p>
  <p> <img alt="レイアウト例" src="gantchart/img19.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> サンプル： <a href="gantchart/Excel_gantchart_chap-02.xlsm">ダウンロード</a></p>
</section>
  
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>

<section>
  <h2> <a name="3._カレンダー部分を作る">3. カレンダー部分を作る</a></h2>
  <h4>[概要]</h4>
  <p> 引き続き VBA 無しで、条件付き書式、excelのセルへの関数指定、などでさらにベース部分を作りこみしてみます。</p>
  <p> &nbsp;</p>

  <h3> 3-1. 「開始日」を指定でカレンダーを更新</h3>
  <p> 最初に日を表示する部分の書式を変更します。<br>&quot;セルの表示設定&quot; を &quot;日のみ&quot;(d) にします。&quot;=date(Y1)&quot; 
  とすることでも同じことをできますが、後で示す曜日の実現でこのセルには年月日の全ての情報を持っていてほしいので、表示形式で&quot;日のみ&quot;の表示を実現します。</p>
  <p> <img alt="表示形式" src="gantchart/imgC1.jpg"></p>
  <p> &nbsp;</p>
  <p> 続いて、カレンダーの最も左側の日付を「開始日」と同じ日にします。</p>
  <p> それ以降の日を、一つ左側のセルの翌日とします。</p>
  <p> 左側から２つ目のセルを設定したらドラッグでOKです。</p>
  <p> <img alt="表示例" src="gantchart/img8.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> <img alt="表示例" src="gantchart/img9.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>

  <h3> 3-2. 月を表示</h3>
  <p> 次に月の部分を作ります。</p>
  <p> 月表示は以下の条件で行います。</p>
  <p>・最も左側のセルは月を表示</p>
  <p>・各月の１日に対応するセルは月を表示</p>
  <p>・以上の条件以外、空欄</p>
  <p> &nbsp;</p>
  <p> &quot;セルの書式設定&quot; を &quot;月のみ&quot;(m)とします。</p>
  <p> <img alt="書式設定例" src="gantchart/img10.jpg"></p>
  <p> &nbsp;</p>
  <p> 一番左側のセルは、真下と同じ日付を代入、月をそのまま無条件で表示します。</p>
  <p> <img alt="表示例" src="gantchart/img12.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> それ以外のセルは、参照するセルを各セルの真下として、日付が１のときだけ日付を代入し、それ以外は空欄を代入します。</p>
  <p> <img alt="表示例" src="gantchart/img14.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>

  <h3> 3-3. 曜日を表示</h3>
  <p> 次に曜日表示です。こちらは全部のセルが同じ手順です。</p>
  <p> 真上のセルを参照し、「=TEXT(AH5, &quot;AAA&quot;)」という式で曜日を計算して表示してくれます。</p>
  <p> <img alt="曜日 表示例" src="gantchart/img16.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>

  <h3> 3-4. 月の部分は 1日なら左側に縦罫線、翌日が&quot;END&quot;なら右側に縦罫線</h3>
  <p> 今のままでは月の切り替わり部分、最終セルの右側、に罫線がありません。</p>
  <p> 美しくないので、ここに罫線を自動追加されるように &quot;条件付き書式&quot; を設定します。</p>
  <p> &nbsp;</p>
  <p> <img alt="罫線 表示例" src="gantchart/img1D.jpg"> <img alt="罫線表示例" src="gantchart/img1E.jpg"></p>
  <p> &nbsp;</p>
  <p> 月部分の全セルを選択後、&quot;条件付き書式&quot;を設定します。</p>
  <p> <img alt="書式ルール" src="gantchart/img21.jpg"></p>
  <p> <img alt="書式設定 罫線" src="gantchart/img22.jpg"></p>
  <p> &nbsp;</p>
  <p> <img alt="書式ルール" src="gantchart/img23.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> これで月の切り替わりに罫線が入りました。</p>
  <p> <img alt="表示例" src="gantchart/img24.jpg"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> 同様に、最終列に罫線を加える作業をします。最終列のセルに &quot;END&quot; という表記を入れてこれをマークにして書式指定します。</p>
  <p> <img alt="書式ルール" src="gantchart/img26.jpg"></p>
  <p> &nbsp;</p>
  <p> この場合は右側に縦の罫線を追加します。</p>
  <p> <img alt="書式設定 罫線" src="gantchart/img27.jpg"></p>
  <p> &nbsp;</p>
  <p> こういう書式設定を行いました。</p>
  <p> <img alt="書式ルール" src="gantchart/img29.jpg" width="1000"></p>
  <p> &nbsp;</p>
  <p> 最終列にも罫線が入りました。</p>
  <p> <img alt="表示例 罫線" src="gantchart/img2A.jpg"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>

  <h3> 3-5. カレンダーの土日を別の色にする</h3>
  <p> &nbsp;</p>
  <p> こちらも条件付き書式を使って実現します。こちら比較的簡単なのでラフに記載します。</p>
  <p> &nbsp;</p>
  <p> 1. 条件付き書式で新しいルールを作成します。</p>
  <p> 色付けする範囲を選択後、条件付き書式から「新しいルール」を選択します。</p>
  <p> <img alt="条件付き書式" src="gantchart/img6.jpg"></p>
  <p> &nbsp;</p>
  <p> 2. ルールは「数式を使用して、書式設定をするセルを決定」とし、ルールを下図のように設定します。</p>
  <p> 5 の方のみを"$"で指定します。AHに"$"を付けてはいけません。</p>
  <blockquote>
    =TEXT(AH$5,"aaa")="土"</blockquote>
  <p> TEXT 関数で "aaa" の指定は曜日表記のところでも使用しました。便利なのでぜひ覚えていただきたいです。</p>
  <p> セルの色は［書式(F)...］から水色を設定しました。</p>
  <p> &nbsp;</p>
  <p> <img alt="データの入力規則" src="gantchart/img4.jpg"></p>
  <p> &nbsp;</p>
  <p> 3. 「条件付き書式ルールの管理」から状態を確認すると、下図のようになっているはずです。</p>
  <p> 書式ルールの表示として「このワークシート」を選択してください。</p>
  <p> 適用先を色を付ける全ての範囲として、下図では、"$AH$5:$H$106" を設定できています。</p>
  <p> <img alt="書式ルール" src="gantchart/img3.jpg"></p>
  <p> &nbsp;</p>
  <p> 4. 同様に日曜日も同じ手順で進めます。</p>
  <p> 書式設定の部分で "土" を "日" へ変更するだけなので、説明は割愛します。</p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> サンプル： <a href="gantchart/Excel_gantchart_chap-03.xlsm">ダウンロード</a></p>
</section>

<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2> <a name="4._設定１_を作る">4. 設定１ を作る</a></h2>
  <h4>[概要]</h4>
  <p> 引き続き VBA 無しで、条件付き書式、excelのセルへの関数指定、などでさらにベース部分を作りこみしてみます。</p>
  <p> &nbsp;</p>
  
<section>
  <h3> 4-1. 「担当」を選べるようにする</h3>
  <p> 1. 「設定１」シートに「担当」一覧を準備します。</p>
  <p> １行目を空欄のセルにしておくことをお勧めします。</p>
  <p> <img alt="設定１ &gt; 担当" src="gantchart/img13.jpg" width="600"></p>
  <p> &nbsp;</p>
  <p> 2. 担当欄 のセルを設定します。</p>
  <p> 担当を入力するセルを全て選択した状態で Excel メニューから、"データ" &gt; "データの入力規則" &gt; "データの入力規則(V)..." 
  をクリックします。</p>
  <p> &nbsp;</p>
  <p> 3. 表示したダイアログ画面へ下記のように入力後、［OK］ボタンをクリックします。</p>
  <ul>
	<li>入力値の種類(A)： "リスト" を選択</li>
	<li>"元の値(S)"： 「設定１」シート中の担当一覧を記載するセルを設定します。</li>
  </ul>
  <p> <img alt="データの入力規則" src="gantchart/img4.jpg" width="600"></p>
  <p> &nbsp;</p>
  <p> 以上で設定を完了です。これで下図のようにセル上で担当を選択できるようになりました。</p>
  <p> 
  <img alt="&quot;担当&quot; を選択できるようになった様子" src="gantchart/img7.jpg" width="800"></p>
  <p>&nbsp;</p>
</section>

<p>&nbsp;</p>

<section>
<h3> 4-2. 「ステータス」を選べるようにする</h3>
  <p> 1. 「設定１」シートに「ステータス」一覧を準備します。</p>
  <p> １行目を空欄のセルにしておくことをお勧めします。</p>
  <p> <img alt="ステータス一覧" src="gantchart/img5.jpg" width="600"></p>
  <p> &nbsp;</p>
  <p> 2. ステータス欄 のセルを設定します。</p>
  <p> ステータスを入力するセルを全て選択した状態で Excel メニューから、"データ" &gt; "データの入力規則" &gt; "データの入力規則(V)..." 
  をクリックします。</p>
  <p> &nbsp;</p>
  <p> 3. 表示したダイアログ画面へ下記のように入力後、［OK］ボタンをクリックします。</p>
  <ul>
	<li>入力値の種類(A)： "リスト" を選択</li>
	<li>"元の値(S)"： 「設定１」シート中のステータス一覧を記載するセルを設定します。</li>
  </ul>
  <p> <img alt="データの入力規則" src="gantchart/img15.jpg" width="600">&nbsp;</p>
  <p> &nbsp;</p>
  <p> 以上で設定を完了です。これで下図のようにセル上でステータスを選択できるようになりました。</p>
  <p> <img alt="ステータス選択" src="gantchart/img17.jpg" width="800"></p>
  <p> &nbsp;</p>
</section>

<p>&nbsp;</p>

<section>
<h3> 4-3. ステータスを「WBS終了条件」にしたら、行をグレー化する</h3>
  <p> 1. 「設定１」シートに「WBS終了判定」一覧を準備します。</p>
  <p> ［重要］必ず "ステータス" 一覧で設定したものと一致する名称を設定してください。</p>
  <p> <img alt="WBS終了判定 一覧" src="gantchart/img20.jpg" width="600"></p>
  <p> &nbsp;</p>
  <p> 2. グレー化する対象の全セルを選択します。ここでは「$A$7:$HI$106」を選択します。</p>
  <p> &nbsp;</p>
  <p> 3. 条件付き書式で新しいルールを作成します。</p>
  <p> 色付けする範囲を選択後、条件付き書式から「新しいルール」を選択します。</p>
  <p> <img alt="条件付き書式" src="gantchart/img6.jpg"></p>
  <p> &nbsp;</p>
  <p> 4. ルールは「数式を使用して、書式設定をするセルを決定」とし、ルールを下図のように設定します。</p>
  <p> 設定との一致確認の方法として、ここでは COUNTIF 関数を使っています。</p>
  <blockquote>
    =COUNTIF(設定1!$D$3:$D$5,$S7)&gt;=1</blockquote>
    
    <div class="status_warning">
      <div></div>
      <div>
        <p><strong>重要</strong></p>
        <p>"$S7" の部分について、S のみを"$"で指定します。<span class="auto-style1">7 に "$" を付けてはいけません</span>。</p>
      </div>
    </div>

  <p> &nbsp;</p>
  <p> セルの色は［書式(F)...］から 25% グレーを設定しました。</p>
  <p> <img alt="条件付き書式設定" src="gantchart/imgF.jpg" width="500"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> 5. 「条件付き書式ルールの管理」から状態を確認すると、下図のようになっているはずです。</p>
  <p> 書式ルールの表示として「このワークシート」を選択してください。</p>
  <p> 適用先を色を付ける全ての範囲として、下図では、"$A$7:$HI$106" を設定しています。</p>
  <p> <img alt="条件付き書式" src="gantchart/img18.jpg" width="800"></p>
  <p> &nbsp;</p>
</section>

<p> &nbsp;</p>

<section>
<h3> 4-4. カレンダーの色表示を祝日対応する</h3>
  <p> 土曜日、日曜日に色付けする方法とほとんど同じです。こちらも条件付き書式を使って実現します。</p>
  <p> &nbsp;</p>
  <p> 1. 「設定１」シートに祝日とする年月日一覧を準備します。</p>
  <p> <img alt="祝日" src="gantchart/imgB.jpg" width="800"></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> 2. 条件付き書式で新しいルールを作成します。</p>
  <p> 色付けする範囲を選択後、条件付き書式から「新しいルール」を選択します。</p>
  <p> <img alt="条件付き書式" src="gantchart/img6.jpg"></p>
  <p> &nbsp;</p>
  <p> 3. ルールは「数式を使用して、書式設定をするセルを決定」とし、ルールを下図のように設定します。</p>
  <p> 祝日との一致確認の方法として、ここでは COUNTIF 関数を使っています。</p>
  <blockquote>
    =COUNTIF(設定1!$E$3:$E$311,AH$5)&gt;=1</blockquote>
    
    <div class="status_warning">
      <div></div>
      <div>
        <p><strong>重要</strong></p>
        <p>"AH$5" の部分について、5 のみを"$"で指定します。<span class="auto-style1">AH に "$" を付けてはいけません</span>。</p>
      </div>
    </div>

  <p> &nbsp;</p>
  <p> セルの色は［書式(F)...］からオレンジ色を設定しました。</p>
  <p> <img alt="書式ルールの編集" src="gantchart/imgA1.jpg" width="500"></p>
  <p> &nbsp;</p>
  <p> 4. 「条件付き書式ルールの管理」から状態を確認すると、下図のようになっているはずです。</p>
  <p> 書式ルールの表示として「このワークシート」を選択してください。</p>
  <p> 適用先を色を付ける全ての範囲として、下図では、"$AH$5:$HI$106" を設定しています。</p>
  <p> <img alt="条件付き書式ルールの管理" src="gantchart/imgE.jpg" width="800"></p>
  <p> &nbsp;</p>
  <p> 以上で祝日表示対応の設定を完了です。</p>
</section>
</section>

<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2> <a name="5._ガントチャート(図)を描画">5. ガントチャート(図)を描画</a></h2>
  <h4>[概要]</h4>
  <p> 計画、実績 の期間を入力したら、その内容に従ってガントチャート（図）を作図する処理を追加します。</p>
  <p> VBA を使います。</p>
  <p> &nbsp;</p>
  <p> 1.</p>
  <p> まずは基本的な部分から。</p>
  <p> 線を描画するには Shapes.AddLine という関数を使用することでできるようです。<br>
  そのまま直接使ってもよさそうですが、複数個所で使用しそうな気がするので、あとで一括して変更することを想定して標準モジュール内で関数化しました。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    線を引く
'
' 引数：    sheet       線を引くシート
'           beginX      線の起点 X
'           endX        線の起点 Y
'           beginY      線の終点 X
'           endY        線の終点 Y
' 戻値：    shape       引いた線
Function drawLine(sheet As Worksheet, beginX As Long, beginY As Long, endX As Long, endY As Long) As shape
    Set drawLine = sheet.Shapes.AddLine(beginX, beginY, endX, endY)
End Function</pre>
  <p> &nbsp;</p>
  <p> 2.</p>
  <p> 計画の線を引く、実績の線を引く、という２つの関数を作成します。</p>
  <p> 開始と終了のセルを指定することでその間に線を描画する、という内容です。</p>
  <p> ガントチャートシートのVBAとして記載します。</p>
  <pre class="prettyprint linenums lang-vb">
Private Const START_DATE_RANGE = 34
Private Const START_WBS = 7
Private Const GANTCHART_SHEET_NAME = "ガントチャート（6か月）"
Private Const SETTING_SHEET_1_NAME = "設定1"
Private Const SETTING_SHEET_2_NAME = "設定2"
Private Const NAME_KEIKAKU = "keikaku_"
Private Const NAME_JISSEKI = "jisseki_"


'
' 概要：    計画の線を一本引く
'
Private Function 計画の線を引く(startCell As Range, endCell As Range) As shape
    Dim thisShape As shape
    Set thisShape = drawLine(ThisWorkbook.ActiveSheet, startCell.Left + 2, startCell.Top + startCell.Height / 4, endCell.Left + endCell.Width, endCell.Top + endCell.Height / 4)
    With thisShape.Line
        .DashStyle = msoLineSolid
        .ForeColor.ObjectThemeColor = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME).Range("D3")
        .ForeColor.TintAndShade = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME).Range("D4")
        .Weight = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME).Range("D5")
        
    End With
    
    thisShape.name = NAME_KEIKAKU &amp; startCell.Row
    
    Set 計画の線を引く = thisShape
End Function


'
' 概要：    実績の線を一本引く
'
Private Function 実績の線を引く(startCell As Range, endCell As Range) As shape
    Dim thisShape As shape
    Dim settingSheet As Worksheet
    
    Set settingSheet = ThisWorkbook.Sheets(SETTING_SHEET_2_NAME)
    
    Set thisShape = drawLine(ThisWorkbook.ActiveSheet, startCell.Left + 2, startCell.Top + startCell.Height * 3 / 4, endCell.Left + endCell.Width, endCell.Top + endCell.Height * 3 / 4)
    
    With thisShape.Line
        .DashStyle = msoLineSolid
        .ForeColor.ObjectThemeColor = settingSheet.Range("D6")
        .ForeColor.TintAndShade = settingSheet.Range("D7")
        .Weight = settingSheet.Range("D8")
        
        .BeginArrowheadStyle = msoArrowheadOpen
        .BeginArrowheadLength = msoArrowheadShort
        .BeginArrowheadWidth = msoArrowheadNarrow
        .BeginArrowheadLength = settingSheet.Range("D9").Value   ' msoArrowheadShort
        .BeginArrowheadWidth = settingSheet.Range("D10").Value   ' msoArrowheadNarrow
        
        .EndArrowheadStyle = msoArrowheadOpen
        .EndArrowheadLength = msoArrowheadShort
        .EndArrowheadWidth = msoArrowheadNarrow
        .EndArrowheadLength = settingSheet.Range("D11").Value    ' msoArrowheadShort
        .EndArrowheadWidth = settingSheet.Range("D12").Value     ' msoArrowheadNarrow
        
    End With
    
    thisShape.name = NAME_JISSEKI &amp; startCell.Row
    
    Set 実績の線を引く = thisShape
    
End Function</pre>
  <p> &nbsp;</p>
  <p> 3.</p>
  <p> ガントチャート全体を更新する関数（UpdateGantchar()）を作成します。</p>
  <p> 「線を一括削除する」関数の部分は後程。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    シート上の線(Line)を全て消す
'
Public Sub deleteAllLines()
    Call 線を一括削除する(ThisWorkbook.Sheets(GANTCHART_SHEET_NAME))
End Sub


'
' 概要：    ガントチャート表示の最初の日を日付型（Date）で取得します。
'
' 戻値：    ガントチャート表示の最初の日を日付型（Date）で返します。
'
' 補足：    CDate 関数は、文字列や数値などを日付型 (Date) に変換します。
'           下記では CDate(Cells(5,29)) としていますが、CDate(Cells(5,20)) でも同じ結果となります。
'
Function GetStartDate() As Date
    GetStartDate = CDate(Cells(5, START_DATE_RANGE))
End Function


'
' 概要：    ガントチャート表示の最後の日を日付型（Date）で取得します。
'
' 戻値：    ガントチャート表示の最後の日を日付型（Date）で返します。
'
' 補足：    CDate 関数は、文字列や数値などを日付型 (Date) に変換します。
'           最後の日の見つけ方を１行目の末尾セル（'END'が記載されている場所）として探しているので
'           １行目の 'END'を消したり'END'以降に何かを書くと正常に動作しません。
'
Function GetEndDate() As Date
    GetEndDate = CDate(Cells(5, getMaxCol(ThisWorkbook.ActiveSheet, 1)))
End Function


'
' 概要：    ガントチャート表示を更新する
'
Public Sub UpdateGantchart()
    Dim thisShape As shape
    Dim keikaku_start As Long
    Dim keikaku_end As Long
    Dim jisseki_start As Long
    Dim jisseki_end As Long
    
    Dim retStart As Long
    Dim retEnd As Long
    
            
    ' 全てのラインを消す
    Call deleteAllLines
    
    Dim i As Long
    For i = START_WBS To getMaxRow(ThisWorkbook.ActiveSheet, 1)
    
        ' 計画を描画
        If Cells(i, "V").Value &lt;&gt; "" And Cells(i, "Y") &lt;&gt; "" Then
        
            retStart = SearchDate(Cells(i, "V"))
            If retStart &lt;&gt; -1 Then
                keikaku_start = retStart
            Else
                keikaku_start = START_DATE_RANGE
            End If
            
            retEnd = SearchDate(Cells(i, "Y"))
            If retEnd &lt;&gt; -1 Then
                keikaku_end = retEnd
            Else
                keikaku_end = getMaxCol(ThisWorkbook.ActiveSheet, 1)
            End If
            
            If (GetEndDate() - CDate(Cells(i, "V").Value) &gt;= 0) And (CDate(Cells(i, "Y")) - GetStartDate() &gt;= 0) Then
                Set thisShape = 計画の線を引く(Cells(i, keikaku_start), Cells(i, keikaku_end))
            End If
        End If
        
        ' 実績を描画
        If Cells(i, "AB") &lt;&gt; "" And Cells(i, "AE") Then
            retStart = SearchDate(Cells(i, "AB"))
            If retStart = -1 Then
                jisseki_start = START_DATE_RANGE
            Else
                jisseki_start = retStart
            End If
            
            retEnd = SearchDate(Cells(i, "AE"))
            If retEnd = -1 Then
                jisseki_end = getMaxCol(ThisWorkbook.ActiveSheet, 1)
            Else
                jisseki_end = retEnd
            End If
            
            If (GetEndDate() - CDate(Cells(i, "AB").Value) &gt;= 0) And (CDate(Cells(i, "AE")) - GetStartDate() &gt;= 0) Then
                Set thisShape = 実績の線を引く(Cells(i, jisseki_start), Cells(i, jisseki_end))
                
                If retStart = -1 Then
                    With thisShape.Line
                        .BeginArrowheadStyle = msoArrowheadNone
                    End With
                End If
                
                If retEnd = -1 Then
                    With thisShape.Line
                        .EndArrowheadStyle = msoArrowheadNone
                    End With
                End If
            End If
        End If
    Next i
End Sub</pre>
  <p> &nbsp;</p>
  <p> 下記部分について補足です。<br>ここは実績の線を引くときに、開始日や終了日がカレンダー範囲外であるときに矢印の形状を変更しています。</p>
  <p> 具体的には、例えば → を － へ変更することで終端でないことを表現しています。</p>
  <pre class="prettyprint linenums lang-vb">
            If (GetEndDate() - CDate(Cells(i, "AB").Value) &gt;= 0) And (CDate(Cells(i, "AE")) - GetStartDate() &gt;= 0) Then
                Set thisShape = 実績の線を引く(Cells(i, jisseki_start), Cells(i, jisseki_end))
                
                If retStart = -1 Then
                    With thisShape.Line
                        .BeginArrowheadStyle = msoArrowheadNone
                    End With
                End If
                
                If retEnd = -1 Then
                    With thisShape.Line
                        .EndArrowheadStyle = msoArrowheadNone
                    End With
                End If
            End If</pre>
  <p> &nbsp;</p>
  <p> 4.</p>
  <p> 上記関数を呼ぶためのトリガーとして、セルの値が更新されたときにガントチャート更新を実施するように Worksheet_Change() 
  関数を設定します。</p>
  <p> 具体的には、計画および実績の開始日・終了日を変更することでバーチャートが更新されるイメージです。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    セルに変化があった時のイベント処理
'
' 著作：    木下英俊
' 履歴：
'           2020-07-08 新規作成
'
Private Sub Worksheet_Change(ByVal Target As Range)
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    
    ' レイアウト更新
    Call UpdateLayout
    
    ' ナンバリングを更新
    'Call UpdateNumbering
    Call UpdateNumbering2
    
    ' ガントチャートを更新
    Call UpdateGantchart
    
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub</pre>
</section>

<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2> <a name="6._描画済みガントチャート(図)を全削除">6. 描画済みガントチャート(図)を全削除</a></h2>
  <h4>[概要]</h4>
  <p> 描画済みのガントチャート(図)を全て削除する処理を追加します。画面更新するためには、一旦すべての表示済みの線を削除する必要があります。</p>
  <p> 
  「線を一括削除する」という関数を作成します。汎用性を考えて標準モジュールとして作成しています。これに伴って引数として対象のシートを渡す必要があります。</p>
  <p> &nbsp;</p>
    
    <div class="status_ok">
      <div></div>
      <div>
        <p><strong>POINT</strong></p>
        <p>ガントチャート以外の図を消さないようにします。これを行わないとメモなどの図やテキストもすべて削除されてしまうので不便です。</p>
		<p>Type が msoLine のものだけを削除する、という方法でとりあえず実現できてそうです。</p>
      </div>
    </div>

    <p> &nbsp;</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    線を一括削除する
'
' 引数：    sheet       処理対象のシート
'
' 著作：    木下 英俊
' 履歴：    2020-07-07  新規作成
' 補足：    Excel画面から手動で描画した線の Type は "msoAutoShape" になって区別できるようです。
'           "msoAutoShape" の値は 1 です。
' 参考：    https://docs.microsoft.com/ja-jp/office/vba/api/office.msoshapetype
'
Sub 線を一括削除する(sheet As Worksheet)
  Dim shp As shape
  For Each shp In sheet.Shapes
    If shp.Type = msoLine Then
        shp.Delete
    End If
  Next shp
End Sub</pre>
  <p> &nbsp;</p>
  <p> このプログラム中で描画する線は Type = msoLine (9) となります。</p>
  <p> ちなみに Excel で通常描画する線の Type を確認してみたら msoAutoShape (1) でした。<br>
  このため上記プログラムで線を削除するとガントチャートで自動作成した線のみを削除できます。手動で描いた線は残るので便利で良い感じになりました。</p>
  <p> &nbsp;</p>
  <p> ここまでの内容で、セルに直接日付を入力すればガントチャート上に線を描画できるように（たぶん）なったはずです。</p>
  <p> あとはセルを選択してからコンテキストメニューをクリックする、という処理の部分だけですね。</p>
</section>

<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2> <a name="7._独自のコンテキストメニューを追加">7. 独自のコンテキストメニューを追加</a></h2>
  <h4>[概要]</h4>
  <p> 独自の右クリックメニュー(コンテキストメニュー)を追加する方法を示します。</p>
  <p> 右クリックメニューとして「計画を設定」「実績を設定」を追加します。</p>
  <p> 合わせて、これらメニューを選択したときに対応する計画および実績のセルを更新します。</p>
  <p> &nbsp;</p>
  <p> 1.</p>
  <p> まずはメニューを追加、削除する関数を作成します。<br>下記部分は 標準モジュール で作成する必要があります。</p>
  <pre class="prettyprint linenums lang-vb">
Sub SelectKeikakuPeriodMenu()
    'MsgBox "計画を設定"
    Call ThisWorkbook.ActiveSheet.UpdateKeikaku
End Sub

Sub SelectJissekiPeriodMenu()
    'MsgBox "実績を設定"
    Call ThisWorkbook.ActiveSheet.UpdateJisseki
End Sub


'
' 概要：    コンテキストメニューを追加する
'
Sub AddOriginalMenu()
    With CommandBars("Cell").Controls.Add(Type:=msoControlButton) '右クリックメニューを追加
        .Caption = "計画を設定"                 ' 追加するメニューの名前
        .OnAction = "SelectKeikakuPeriodMenu"   ' メニューを押した時に実行されるマクロ名
        .BeginGroup = True                      ' セパレータを追加
    End With

    With CommandBars("Cell").Controls.Add(Type:=msoControlButton) '右クリックメニューを追加
        .Caption = "実績を設定"                 ' 追加するメニューの名前
        .OnAction = "SelectJissekiPeriodMenu"   ' メニューを押したときに実行されるマクロ名
    End With
End Sub


'
' 概要：    コンテキストメニューを削除する
'
Sub DeleteOriginalMenu()    'マクロ名
    On Error Resume Next    ' エラーでも次の行へ...
    CommandBars("Cell").Controls("計画を設定").Delete
    CommandBars("Cell").Controls("実績を設定").Delete
End Sub</pre>
  <p> &nbsp;</p>
  <p> 2.</p>
  <p> 続いて、コンテキストメニューを実際に追加する部分を作成します。</p>
  <p> こちらはシート側の処理として作成します。</p>
  <p> ワークシートを右クリックしたときの処理から関数 AddOriginalMenu を実行します。</p>
  
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    選択状態のセルが下記条件を満足するかを確認する。
'           (1) 選択は１行のみであること
'           (2) ガントチャート表示エリア内であること
'
' 戻値：    True    表示エリア内
'           False   表示エリア外
'
Private Function JudgeSelectObjectAndArea() As Boolean
    JudgeSelectObjectAndArea = False

    ' セルが選択されている？
    If TypeName(Selection) = "Range" Then                
        ' 選択範囲は１行？ 複数行ならNG
        If Selection.Rows.Count = 1 Then
            ' 選択範囲の最も左側は指定範囲内？
            If Selection(1).Column &gt;= START_DATE_RANGE Then            
                ' 選択範囲の最も右側は指定範囲内？
                If Selection(Selection.Count).Column &lt;= getMaxCol(ThisWorkbook.ActiveSheet, 1) Then
                    ' 選択範囲は条件を満足する
                    JudgeSelectObjectAndArea = True
                End If                
            End If
        End If
    End If
End Function


'
' 概要：    右クリック時のイベント処理
'
' 履歴：
'           2020-07-08 新規作成
'
Private Sub Worksheet_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)

    ' オリジナルメニューを削除
    Call DeleteOriginalMenu
    
    ' 右クリックエリアがカレンダー内なら、オリジナルメニューを追加
    If JudgeSelectObjectAndArea() = True Then
        Call AddOriginalMenu
    End If
    
End Sub</pre>

  <p> &nbsp;</p>
  <p> JudgeSelectObjectAndArea() の判定があるので、不適切なセル選択を行っている場合はオリジナルメニューを表示しません。</p>
  <p> &nbsp;</p>
  <p> 3.</p>
  <p> 続いて、関数 UpdateKeikaku() と UpdateJisseki() を作ります。</p>
  
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    日付表示範囲を探索して、指定セルと同じ日付のセルを探してその位置を返す
'
' 引数：    dateCell：      探索する日付を表記している Cell
'
' 戻値：    1以上の値 ：    見つけたセルの水平位置
'           -1 ：           該当セル無し
'
Private Function SearchDate(dateCell As Range) As Long
    Dim i As Long
    Dim maxCol As Long
    
    Debug.Print "dateCell.value = "; dateCell.Value;
    
    maxCol = getMaxCol(ThisWorkbook.ActiveSheet, 1)
    'Debug.Print "maxCol = "; maxCol;
    
    For i = START_DATE_RANGE To maxCol
        'Debug.Print Cells(5, i).Value
        If Cells(5, i).Value = dateCell.Value Then
            SearchDate = i
            Exit For
        End If
    Next i
    If i &gt; maxCol Then
        SearchDate = -1
    End If
End Function


'
' 概要：    日付表示範囲から、指定する水平位置の日付情報を取得する
'
' 引数：    position：      水平位置
'
' 戻値：    指定位置の日付情報
'           ""      指定位置が欄外の場合、"" を返す。
'
Private Function GetDate(position As Long) As String
    ' 日付表示範囲であることを確認
    If position &gt;= START_DATE_RANGE And position &lt;= getMaxCol(ThisWorkbook.ActiveSheet, 1) Then
        GetDate = Cells(5, position)
    Else
        GetDate = ""
    End If        
End Function


'
' 概要：    選択されているセル情報に従って "計画" を更新する
'
' 詳細：    選択セルの情報に従って"計画"を更新します。
'           選択セルが適切な位置であるときのみ実施します。
'           選択セルが適切でない場合、"計画"の更新を行いません。
'
' 補足：    "Selection(1)"               で選択している最初のセルを返します。
'           "Selection(Selection.Count)" で選択している最後のセルを返します。
'           "Selection(1).Column"        で選択している最初のセル（左上）の列番号を返します。
'           "Selection(1).Row"           で選択している最初のセル（左上）の行番号を返します。
'
Public Sub UpdateKeikaku()
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    
    Dim thisShape As shape

    ' 選択セルを確認
    If JudgeSelectObjectAndArea() = True Then
    
        Call 名称指定で図を削除する(ThisWorkbook.ActiveSheet, NAME_KEIKAKU &amp; Selection(1).Row)
        
        ' 計画セルを更新
        Cells(Selection.Row, "V").Value = GetDate(Selection(1).Column)
        Cells(Selection.Row, "Y").Value = GetDate(Selection(Selection.Count).Column)
        
        Set thisShape = 計画の線を引く(Selection(1), Selection(Selection.Count))
        
        'Call UpdateGantchart
        
    End If

    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub


'
' 概要：    選択されているセル情報に従って "実績" を更新する
'
' 詳細：    選択セルの情報に従って"実績"を更新します。
'           選択セルが適切な位置であるときのみ実施します。
'           選択セルが適切でない場合、"実績"の更新を行いません。
'
' 補足：    "Selection(1)"               で選択している最初のセルを返します。
'           "Selection(Selection.Count)" で選択している最後のセルを返します。
'           "Selection(1).Column"        で選択している最初のセル（左上）の列番号を返します。
'           "Selection(1).Row"           で選択している最初のセル（左上）の行番号を返します。
'
Public Sub UpdateJisseki()
    Application.EnableEvents = False
    Application.ScreenUpdating = False

    ' 選択セルを確認
    If JudgeSelectObjectAndArea() = True Then
    
        Call 名称指定で図を削除する(ThisWorkbook.ActiveSheet, NAME_JISSEKI &amp; Selection(1).Row)
        
        ' 計画セルを更新
        Cells(Selection.Row, "AB").Value = GetDate(Selection(1).Column)
        Cells(Selection.Row, "AE").Value = GetDate(Selection(Selection.Count).Column)
        
        Set thisShape = 実績の線を引く(Selection(1), Selection(Selection.Count))
        'Call UpdateGantchart
        
    End If

    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub </pre>
  <p> &nbsp;</p>
  <p> こちらは標準モジュール側へ実装しました。</p>
  
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    名前を指定して図を削除する
'
' 引数：    sheet       処理対象のシート
'           name        図の名称（Shape.Name）
'
' 著作：    木下 英俊
' 履歴：    2020-07-07  新規作成
'
Sub 名称指定で図を削除する(sheet As Worksheet, name As String)
  Dim shp As shape
  For Each shp In sheet.Shapes
    If shp.name = name Then
        shp.Delete
    End If
  Next shp
End Sub</pre>
  <p> &nbsp;</p>
  <p> これで大体完成です。</p>
</section>
  
<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2> <a name="8._ワークブック終了処理、デアクティブ時の処理">8. ワークブック終了処理、デアクティブ時の処理</a></h2>
  <h4>[概要]</h4>
  <p> エクセルワークブックを閉じる際の後処理を実装します。</p>
  <p> ・独自のコンテキストメニューを削除します。</p>
  <p> &nbsp;</p>
  <p> 同様に、別のエクセルブックを使用するなどによりデアクティブになった際の処理を実装します。</p>
  <p> ・独自のコンテキストメニューを削除します。</p>
  <p> &nbsp;</p>
  <p> 1.</p>
  <p> ThisWorkbook の処理として以下を実装します。</p>
  <p> この処理を行わないと、無関係な Excel ファイルを開いたときにも独自メニューを表示してしまいます。</p>
  <pre class="prettyprint linenums lang-vb">
Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Call DeleteOriginalMenu
End Sub

Private Sub Workbook_WindowDeactivate(ByVal Wn As Window)
    Call DeleteOriginalMenu
End Sub</pre>
  <p> &nbsp;</p>
  <p> 2.</p>
  <p> ガントチャートシートの処理として以下を実装します。</p>
  <p> この処理を行わないと、無関係なシートを表示したときに独自メニューを表示してしまいます。</p>
  <pre class="prettyprint linenums lang-vb">
'
' 概要：    このシートがアクティブになった時のイベント処理
'
Private Sub Worksheet_Activate()
    Application.EnableEvents = False
    Application.ScreenUpdating = False

    ' 表示を”標準”に
    ActiveWindow.View = xlNormalView
    
    ' ガントチャートを更新
    Call UpdateGantchart
    
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub


'
' 概要：    このシートがディアクティブになった時のイベント処理
'           オリジナルメニューの削除を行います。
'
Private Sub Worksheet_Deactivate()
    ' オリジナルメニューを削除
    Call DeleteOriginalMenu
End Sub</pre>

</section>  


<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
  
<section>
  <h2> <a name="9._設定２_を作る">9. 設定２ を作る</a></h2>
  <p> "設定２" のキモは、シートで設定した設定値を画面上にプレビュー表示する、という部分だけですね。</p>
  <p> "設定２" のシート用に下記 VBA プログラムを準備するだけです。</p>
  <p> &nbsp;</p>
  <pre class="prettyprint linenums lang-vb">
Private Sub Worksheet_Activate()
    Call UpdateColor
End Sub

Private Sub Worksheet_Change(ByVal Target As Range)
    Call UpdateColor
End Sub

Private Sub UpdateColor()
    On Error Resume Next    ' エラーでも次の行へ...

    Dim thisSheet As Worksheet
    Dim thisShape As shape
    Dim thisCell As Range
    
    Set thisSheet = ThisWorkbook.Sheets("設定2")
    
    Call 線を一括削除する(thisSheet)
    
    
    ' 計画線
    Set thisCell = Range("E3").MergeArea
    Set thisShape = drawLine(thisSheet, thisCell.Left + 2, thisCell.Top + thisCell.Height / 2, thisCell.Left + thisCell.Width - 2, thisCell.Top + thisCell.Height / 2)
    With thisShape.Line
        .ForeColor.ObjectThemeColor = Range("D3").Value
        .ForeColor.TintAndShade = Range("D4").Value
        .Weight = Range("D5").Value
    End With

    ' 実績線
    Set thisCell = Range("E6").MergeArea
    Set thisShape = drawLine(thisSheet, thisCell.Left + 2, thisCell.Top + thisCell.Height / 2, thisCell.Left + thisCell.Width - 2, thisCell.Top + thisCell.Height / 2)
    With thisShape.Line
        .ForeColor.ObjectThemeColor = Range("D6").Value
        .ForeColor.TintAndShade = Range("D7").Value
        .Weight = Range("D8").Value
        
        .BeginArrowheadStyle = msoArrowheadOpen
        .BeginArrowheadLength = msoArrowheadShort
        .BeginArrowheadWidth = msoArrowheadNarrow
        .BeginArrowheadLength = Range("D9").Value   ' msoArrowheadShort
        .BeginArrowheadWidth = Range("D10").Value   ' msoArrowheadNarrow
        
        .EndArrowheadStyle = msoArrowheadOpen
        .EndArrowheadLength = msoArrowheadShort
        .EndArrowheadWidth = msoArrowheadNarrow
        .EndArrowheadLength = Range("D11").Value    ' msoArrowheadShort
        .EndArrowheadWidth = Range("D12").Value     ' msoArrowheadNarrow
    End With

    ' ObjectColor
    For i = 3 To 18
        Set thisShape = drawLine(thisSheet, Cells(i, "I").Left + 2, Cells(i, "I").Top + Cells(i, "I").Height / 2, Cells(i, "I").Left + Cells(i, "I").Width - 2, Cells(i, "I").Top + Cells(i, "I").Height / 2)
        With thisShape.Line
            .Weight = 5
            .ForeColor.ObjectThemeColor = Cells(i, "H").Value
        End With
    Next i

End Sub</pre>
  <p> &nbsp;</p>
  
</section>

<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2><a name="10._既知の問題">10. 既知の問題</a></h2>
  <p>&nbsp;</p>
  <h3>10-1. マルチディスプレイ環境下でバー表示位置がずれる場合がある</h3>
  <p>ＰＣに複数のディスプレイを接続して表示している場合に、バー（ガントチャート横棒）の表示位置がずれる場合があることを確認しています。</p>
  <ul>
    <li>全てのディスプレイ表示倍率が同じ場合、問題を発生しません（例：表示倍率が全て100%）</li>
    <li>
    メインディスプレイと表示倍率が異なるディスプレイ上で本アプリケーションを表示したとき、バー表示位置がずれる場合があります（例：メインディスプレイ 
    125%、サブディスプレイ 100%）</li>
  </ul>
  <p>&nbsp;</p>
  <p class="auto-style1"><strong>解決方法</strong></p>
  <p>Excelの［オプション］を開き、［全般］タブの［ユーザーインターフェイスのオプション］-［複数ディスプレイを使用する場合］の設定を「互換性に対応した最適化(アプリケーションの再起動が必要)」に設定して、Excel 
  を再起動します。</p>
  <p><img alt="互換性に対応した最適化" src="gantchart/img2F.jpg" width="1000"></p>
  <p>&nbsp;</p>
  <p>私の環境ではこれで問題解決できました。お試しください。</p>
  <p>&nbsp;</p>
</section>

<p> &nbsp;</p>
<hr>
<p> &nbsp;</p>

<section>
  <h2><a name="サンプルプログラム">サンプルプログラム</a></h2>
  <p>以上の内容を全て（＋アルファ？）した <strong>Excelガントチャート</strong> を以下からダウンロードできます。<br>
  私自身が業務で使用することを目的にこれをブラッシュアップしているので、ここのが一番完成度が高いです。</p>
  <p>&nbsp;</p>
  <p>サンプルプログラム <a href="gantchart/Excel_gantchart_v1_05.xlsm">ダウンロード</a></p>
  <br>
  <br>
  
  <h4>変更履歴</h4>
  <table>
    <tr>
      <td class="td_history_date">2023-10-01</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.05</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">&nbsp;</td>
      <td class="td_history">微修正</td>
    </tr>
    <tr>
      <td class="td_history_date">2023-01-08</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.04</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">&nbsp;</td>
      <td class="td_history">記事と実装を一致させる、"表示を縮小して全体を表示する"、ゴミ掃除、など微修正</td>
    </tr>
    <tr>
      <td class="td_history_date">2022-06-25</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.03</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">MIT License へ変更</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">VBA のパスワードを外しました。</td>
    </tr>
    <tr>
      <td class="td_history_date">2020-12-24</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.02</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">[Bug-fix] 他のExcelシートのコンテキストメニューにこのガントチャートのオリジナルメニューが表示される場合がある、という不具合を修正。</td>
    </tr>
    <tr>
      <td class="td_history_date">2020-07-09</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.01</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">祝日や任意の休みの表示に対応</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">１行または複数の行を切り取って別の場所へ挿入すると番号が崩れる、という課題を修正</td>
    </tr>
    <tr>
      <td class="td_history_date">2020-07-07</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">v1.00</td>
    </tr>
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">新規作成</td>
    </tr>
  </table>
</section>


<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>

<section>
  <h2><a id="ライセンス">ライセンス</a></h2>
  <p>本ページの情報は、特記無い限り下記 MIT ライセンスで提供されます。</p>
  <div class="license">
  The MIT License (MIT)<br><br>

    Copyright © 2020&nbsp; Kinoshita Hidetoshi<br><br>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:<br><br>

  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.<br><br>

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
  </div>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
</section>

<p>&nbsp;</p>


<section>
  <h2><a name="参考">参考</a></h2>
  <ul>
  	<li>[Excel]VBAで「右クリックメニュー」を追加する<br>
  	<a href="https://m0ratorium.com/vba-rightclickmenuadd/" target="_blank">
  	https://m0ratorium.com/vba-rightclickmenuadd/</a></li>
  	<li>Shape プロパティ (Excel)<br>
  	<a href="https://docs.microsoft.com/ja-jp/office/vba/api/excel.shape.line" target="_blank">
  	https://docs.microsoft.com/ja-jp/office/vba/api/excel.shape.line</a></li>
  	<li>特定のオブジェクトを削除する<br>
  	<a href="http://www4.synapse.ne.jp/yone/excel2010/excel2010_zu_obje_del.html" target="_blank">
  	http://www4.synapse.ne.jp/yone/excel2010/excel2010_zu_obje_del.html</a></li>
  	<li>右クリックメニューやサブメニューにマクロを登録／削除するには<br>
  	<a href="https://www.atmarkit.co.jp/ait/articles/1408/25/news030.html" target="_blank">
  	https://www.atmarkit.co.jp/ait/articles/1408/25/news030.html</a></li>
  	<li>【VBA】選択したセルを取得する『Selectionプロパティ』の使い方<br>
  	<a href="https://detail-infomation.com/vba-selection/" target="_blank">
  	https://detail-infomation.com/vba-selection/</a></li>
  	<li>Excel VBAで外部ファイルのモジュールを読み込み実行する方法<br>
  	<a href="https://eijiman.com/execute-external-file-module-excel-vba/" target="_blank">
  	https://eijiman.com/execute-external-file-module-excel-vba/</a></li>
    <li>MsoShapeType 列挙 (Office) | Microsoft Docs<br>
    <a href="https://docs.microsoft.com/ja-jp/office/vba/api/office.msoshapetype" target="_blank">
    https://docs.microsoft.com/ja-jp/office/vba/api/office.msoshapetype</a></li>
  </ul>
</section>


<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>

<section>
  <h2 style="margin-bottom:5px">変更履歴</h2>

  <table>
  
    <tr>
      <td class="td_history_date">2024-07-25</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">「<a href="#10._既知の問題">10._既知の問題</a>」を記載</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2024-05-09</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">ビデオ、画像のサイズを調整</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2023-10-01</td>
      <td class="td_history_separator">-</td>
      <td class="td_history"><a href="#サンプルプログラム">サンプルプログラム</a>を v1.05 へバージョンアップ</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2023-01-08</td>
      <td class="td_history_separator">-</td>
      <td class="td_history"><a href="#サンプルプログラム">サンプルプログラム</a>を v1.04 へバージョンアップ</td>
    </tr>
  
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">&nbsp;</td>
      <td class="td_history">「<a href="#4._設定１_を作る">4. 設定１ を作る</a>」を記載</td>
    </tr>
  
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">&nbsp;</td>
      <td class="td_history">「<a href="#9._設定２_を作る">9. 設定２ を作る</a>」をサンプルプログラム v1.04 更新に合わせて余分なコードを削除</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2022-06-25</td>
      <td class="td_history_separator">-</td>
      <td class="td_history"><a href="#サンプルプログラム">サンプルプログラム</a>を v1.03 へバージョンアップ<br>
      ライセンスをMITへ変更。VBAのパスワードを解除。</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2022-05-19</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">７章、８章、９章 を追記</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2022-05-18</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">５章、６章を追記</td>
    </tr>
  
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">土日、祝日の色付けについて追記<br>
      </td>
    </tr>
  
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">&nbsp;</td>
      <td class="td_history">(ここを読んでくれる読者が若干名いるようなので少しがんばってみました。VBAの記述も少しずつ足してみたいです。)</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2021-09-05</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">紹介ビデオを追加</td>
    </tr>
  
    <tr>
      <td class="td_history_date">&nbsp;</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">目次体裁を最新フォーマットへ更新</td>
    </tr>
  
    <tr>
      <td class="td_history_date">2021-01-04</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">記事本文を更新</td>
    </tr>
    
    <tr>
      <td class="td_history_date">2020-12-24</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">サンプルプログラムを v1.02 へバージョンアップ</td>
    </tr>
    
    <tr>
      <td class="td_history_date">2020-07-11</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">サンプルプログラムを v1.01 へバージョンアップ</td>
    </tr>
    
    <tr>
      <td class="td_history_date">2020-07-07</td>
      <td class="td_history_separator">-</td>
      <td class="td_history">新規作成 </td>
    </tr>
    
  </table>
  </section>

<p>&nbsp;</p>

<section>
  <p><a href="../index.html" target="_parent">Programming Items トップページ</a></p>
  <p><a href="../privacy_policy.html">プライバシーポリシー</a></p>
</section>

<p>&nbsp;</p>

<footer>
	<p><small>Copyright © 2020 Kinoshita Hidetoshi (木下英俊)</small></p>
</footer>

<p>&nbsp;</p>
</body>
</html>
