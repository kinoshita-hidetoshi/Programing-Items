<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="木下英俊">
  <meta name="description" content="木下英俊が自身のためにプログラムメモを残すことを目的に作成したページです。">
  <meta name="keywords" content="">
  <!-- キャッシュ無効化 -->
  <meta http-equiv="Cache-Control" content="no-cache">
	
  <title>Excel VBA パスワードの解除方法</title>
	
  <!-- CSS -->
  <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../design.css" type="text/css">
  
  <!-- Start for 'google-code-prettify' -->
  <link href="../prettify.css" rel="stylesheet" type="text/css">
  <script src="../prettify.js" type="text/javascript"></script>
  <!-- End for 'google-code-prettify' -->

  <style type="text/css">
  .auto-style1 {
    text-decoration: underline;
  }
  </style>

</head>

<body onload="prettyPrint();">
	
<h1>Excel VBA パスワードの解除方法</h1>

<p> Excel VBA のパスワード解除方法を記載します。</p>
<p> このページは私自身のメモを目的に記載しています。自己責任で使用してください。</p>

<p>&nbsp;</p>
<table style="border: 1px solid #808080; width: 100%; max-width:800px; background-color: #F0F0F0;">
  <tr>
    <td>
      <nav>
        <h2> 目次</h2>
        <p>
        <a href="#1._VBA-マクロのパスワード解除とは？（VBAProjectパスワードのこと）">1. VBA-マクロのパスワード解除とは</a> <br>
        <a href="#2._VBA-PW解除コードの紹介（※コピペでOK）">2. VBA-PW解除コードの紹介（※コピペでOK）</a><br>
        <a href="#3._VBA-紹介コードの使用方法">3. VBA-紹介コードの使用方法</a><br>
        <a href="#参考">参考</a><br>
        </p>
      </nav>
    </td>
  </tr>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>

<section>
	<h2> <a name="1._VBA-マクロのパスワード解除とは？（VBAProjectパスワードのこと）">1. VBA-マクロのパスワード解除とは？（VBAProjectパスワードのこと）</a></h2>
<p> マクロのパスワード解除とは、「VBAProject パスワード」の解除って意味です。</p>
<p> &nbsp;</p>
<p> 下図で赤枠で囲ってあるパスワード解除方法について本記事では触れていきます。</p>
<p> &nbsp;</p>
<p> <img alt="" src="vba_password_unlocked/img19.jpg" width="1000"></p>
<p> &nbsp;</p>
<p> &nbsp;</p>
<h2> <a name="2._VBA-PW解除コードの紹介（※コピペでOK）">2. VBA-PW解除コードの紹介（※コピペでOK）</a></h2>
<p> EXCELのバージョンによって、使用するコードが若干異なります。</p>
<p> &nbsp;</p>
<table style="width: 300px" class="border-collapse">
  <tr>
    <td>
    違う箇所は、変数の部分ですね。<br>
    64bit版だとlongptrという変数を使用しています。
    </td>
  </tr>
</table>
<p> &nbsp;</p>

<p> Excel 32bit 版はこちら</p>

<pre class="prettyprint linenums"><code>Public Const PAGE_EXECUTE_READWRITE = &amp;H40
 
Public Declare PtrSafe Sub MoveMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As LongPtr, Source As LongPtr, ByVal Length As LongPtr)
Public Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As LongPtr, ByVal dwSize As LongPtr, ByVal flNewProtect As LongPtr, lpflOldProtect As LongPtr) As LongPtr
Public Declare PtrSafe Function GetModuleHandleA Lib &quot;kernel32&quot; (ByVal lpModuleName As String) As LongPtr
Public Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr
Public Declare PtrSafe Function DialogBoxParam Lib &quot;user32&quot; Alias &quot;DialogBoxParamA&quot; (ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
Dim HookBytes(0 To 5) As Byte
Dim OriginBytes(0 To 5) As Byte
Dim projectFunction As Long
Dim Flag As Boolean
 
Public Function GetPtr(ByVal Value As LongPtr) As LongPtr
  GetPtr = Value
End Function
 
Public Sub RecoverBytes()
  If Flag Then MoveMemory ByVal projectFunction, ByVal VarPtr(OriginBytes(0)), 6
End Sub

Public Function MyDialogBoxParamater(ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
  If pTemplateName = 4070 Then
    MyDialogBoxParamater = 1
  Else
    RecoverBytes
    MyDialogBoxParamater = MyDialogBoxParamater(hInstance, pTemplateName, hWndParent, lpDialogFunc, dwInitParam)
    HookFlag
  End If
End Function
 
Public Function HookFlag() As Boolean
  Dim TmpBytes(0 To 5) As Byte
  Dim p As Long
  Dim OriginProtect As Long
 
  HookFlag = False
  projectFunction = GetProcAddress(GetModuleHandleA(&quot;user32.dll&quot;), &quot;DialogBoxParamA&quot;)
  If VirtualProtect(ByVal projectFunction, 6, PAGE_EXECUTE_READWRITE, OriginProtect) &amp;lt;&amp;gt; 0 Then
    MoveMemory ByVal VarPtr(TmpBytes(0)), ByVal projectFunction, 6
    If TmpBytes(0) &lt;&gt; &amp;H68 Then
      MoveMemory ByVal VarPtr(OriginBytes(0)), ByVal projectFunction, 6
      p = GetPtr(AddressOf MyDialogBoxParamater)
      HookBytes(0) = &amp;H68
      MoveMemory ByVal VarPtr(HookBytes(1)), ByVal VarPtr(p), 4
      HookBytes(5) = &amp;HC3
      MoveMemory ByVal projectFunction, ByVal VarPtr(HookBytes(0)), 6
      Flag = True
      HookFlag = True
    End If
  End If
End Function
 
 
Sub VBAProjectパスワード解除()
  If HookFlag Then
    MsgBox &quot;VBA Project を解除しました。&quot;, vbInformation, &quot;成功しました。&quot;
  End If
End Sub</code></pre>

<p> &nbsp;</p>

<p> Excel 64bit 版はこちら</p>

<pre class="prettyprint linenums"><code>Public Const PAGE_EXECUTE_READWRITE = &amp;H40
 
Public Declare PtrSafe Sub MoveMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As LongPtr, Source As LongPtr, ByVal Length As LongPtr)
Public Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As LongPtr, ByVal dwSize As LongPtr, ByVal flNewProtect As LongPtr, lpflOldProtect As LongPtr) As LongPtr
Public Declare PtrSafe Function GetModuleHandleA Lib &quot;kernel32&quot; (ByVal lpModuleName As String) As LongPtr
Public Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr
Public Declare PtrSafe Function DialogBoxParam Lib &quot;user32&quot; Alias &quot;DialogBoxParamA&quot; (ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
Dim HookBytes(0 To 5) As Byte
Dim OriginBytes(0 To 5) As Byte
Dim projectFunction As LongPtr
Dim Flag As Boolean
 
Public Function GetPtr(ByVal Value As LongPtr) As LongPtr
  GetPtr = Value
End Function
 
Public Sub RecoverBytes()
  If Flag Then MoveMemory ByVal projectFunction, ByVal VarPtr(OriginBytes(0)), 6
End Sub

Public Function MyDialogBoxParamater(ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
  If pTemplateName = 4070 Then
    MyDialogBoxParamater = 1
  Else
    RecoverBytes
    MyDialogBoxParamater = MyDialogBoxParamater(hInstance, pTemplateName, hWndParent, lpDialogFunc, dwInitParam)
    HookFlag
  End If
End Function
 
Public Function HookFlag() As Boolean
  Dim TmpBytes(0 To 5) As Byte
  Dim p As LongPtr
  Dim OriginProtect As LongPtr
 
  HookFlag = False
  projectFunction = GetProcAddress(GetModuleHandleA(&quot;user32.dll&quot;), &quot;DialogBoxParamA&quot;)
  If VirtualProtect(ByVal projectFunction, 6, PAGE_EXECUTE_READWRITE, OriginProtect) &amp;lt;&amp;gt; 0 Then
    MoveMemory ByVal VarPtr(TmpBytes(0)), ByVal projectFunction, 6
    If TmpBytes(0) &lt;&gt; &amp;H68 Then
      MoveMemory ByVal VarPtr(OriginBytes(0)), ByVal projectFunction, 6
      p = GetPtr(AddressOf MyDialogBoxParamater)
      HookBytes(0) = &amp;H68
      MoveMemory ByVal VarPtr(HookBytes(1)), ByVal VarPtr(p), 4
      HookBytes(5) = &amp;HC3
      MoveMemory ByVal projectFunction, ByVal VarPtr(HookBytes(0)), 6
      Flag = True
      HookFlag = True
    End If
  End If
End Function
 
 
Sub VBAProjectパスワード解除()
  If HookFlag Then
    MsgBox &quot;VBA Project を解除しました。&quot;, vbInformation, &quot;成功しました。&quot;
  End If
End Sub</code></pre>

<p> &nbsp;</p>
<p> &nbsp;</p>
<p> &nbsp;</p>

<h2> <a name="3._VBA-紹介コードの使用方法">3. VBA-紹介コードの使用方法</a></h2>
<p> 
<span style="color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, &quot;Helvetica Neue&quot;, &quot;Hiragino Kaku Gothic ProN&quot;, メイリオ, meiryo, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">
使い方は、以下の通り。</span></p>
<p> &nbsp;</p>
<ol>
  <li>新しいEXCELを開く（以下、Aファイルとする）</li>
  <li>マクロにPWが掛かったEXCELを開く（以下、Bファイルとする）</li>
  <li>Aファイル側にPW解除マクロコードをコピペ（適当な新規プロシージャに。）</li>
  <li>Aファイル側でPW解除コードを実行（実行するSub名：VBAProjectパスワード解除）</li>
  <li>Bファイル側のマクロPWが解除されている</li>
</ol>
<p>&nbsp;</p>
<p><img alt="" src="vba_password_unlocked/img13.jpg" width="1000"></p>
<p> 
&nbsp;</p>
<p> &nbsp;</p>
<p class="auto-style1"> 注意ポイント</p>
<p> &nbsp;</p>
<p> 尚、Bファイルを閉じてしまうとPWロックが復活してしまいますので、<br>もしPW自体を削除したい場合は、PWロック解除後に、<br>
BファイルのVBE側で</p>
<p> 「ツール」→「VBAProjectのプロパティ」</p>
<p> から設定されたパスワードを削除しましょう。<br>そうすればPW復活はしなくなります。</p>
<p> 具体的には、以下のキャプチャの通りの状態にしてあげましょう。</p>
<p> &nbsp;</p>
<p> 
<img alt="" src="vba_password_unlocked/img15.jpg" width="1000"></p>
<p> &nbsp;</p>
</section>

<br>
<br>

<section>
	<h2><a name="参考">参考</a></h2>
	<ul>
		<li>
        <a href="https://nkmrdai.com/vba-password-unrocked/" target="_blank">
        【EXCEL】VBA-マクロのパスワード解除方法【コード有】 (nkmrdai.com)</a><br>
        <a href="https://nkmrdai.com/vba-password-unrocked/" target="_blank">https://nkmrdai.com/vba-password-unrocked/</a></li>
        <li>
        <a href="https://www.saka-en.com/office/excel-vba-password-unlock/" target="_blank">
        Excel VBAマクロ パスワード解除方法 | ホームページ制作のサカエン Developer&#39;s Blog (saka-en.com)</a><br>
        <a href="https://www.saka-en.com/office/excel-vba-password-unlock/" target="_blank">
        https://www.saka-en.com/office/excel-vba-password-unlock/</a></li>
        <li>
        <a href="https://tsurutoro.com/problem-solving/" target="_blank">まるで魔法！！ 
        本当は教えたくない！？簡単ExcelVBAのプロジェクトロックをさらっと解除する方法 | 気楽生活 - OFFICE &amp; OUTDOOR - 
        (tsurutoro.com)</a><br>
        <a href="https://tsurutoro.com/problem-solving/" target="_blank">
        https://tsurutoro.com/problem-solving/</a></li>
	</ul>
</section>

<p>&nbsp;</p>

<hr>

<p style="margin-bottom:5px">&nbsp;</p>

<section>
	<h2 style="margin-bottom:5px">記載</h2>
	<table>
	  <tr>
	    <td class="td_history_date">2021-09-09</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">新規作成 </td>
	  </tr>
	</table>
</section>

<p>&nbsp;</p>

<footer>
	<p><small>&copy; copyright 2021 木下英俊</small></p>
</footer>

</body>
</html>
