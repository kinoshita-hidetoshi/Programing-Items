<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="木下英俊">
  <meta name="description" content="木下英俊が自身のためにプログラムメモを残すことを目的に作成したページです。">
  <meta name="keywords" content="">
  <!-- キャッシュ無効化 -->
  <meta http-equiv="Cache-Control" content="no-cache">
	
	<!-- タイトル -->
  <title>[VBA] Excel VBA パスワードの解除方法</title>
	
  <!-- ファビコン -->
  <link rel="shortcut icon" href="../favicon.ico">
  
  <!-- CSS -->
  <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../design.css" type="text/css">
  
  <!-- Start for 'google-code-prettify' -->
	<link href="../prettify/styles/desert.css" rel="stylesheet" type="text/css">
	<script src="../prettify/prettify.js" type="text/javascript"></script>
  <script src="../prettify/lang-vb.js" type="text/javascript"></script>
  <!-- End for 'google-code-prettify' -->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V2DZQK54C2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-V2DZQK54C2');
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->

  <style type="text/css">
    .auto-style1 {
      text-decoration: underline;
    }
    .auto-style2 {
      background-color: #505000;
    }
  </style>

</head>

<body onload="prettyPrint();">
	
<h1>[Excel VBA] パスワードの解除方法</h1>

<p> 自分が作成した Excel VBA のパスワードを忘れてしまった、ということがありますよね。ここでは Excel VBA のパスワード解除方法を記載します。</p>
<p> このページは私自身のメモを目的に記載しています。自己責任で使用してください。他人が作ったマクロの破壊などに使うのは、絶対にやめましょう。</p>

<p>&nbsp;</p>
<table style="border: 1px solid #808080; width: 100%; max-width:800px; background-color: #F0F0F0;">
  <tr>
    <td>
      <nav>
        <h2> 目次</h2>
        <p><a href="#1._VBA-マクロのパスワード解除とは？（VBAProjectパスワードのこと）">1. VBA-マクロのパスワード解除とは</a></p>
        <p><a href="#2._方法１">2. 方法１</a></p>
        <p>&nbsp;&nbsp; <a href="#2-1._VBA-PW解除コードの紹介（※コピペでOK）">2-1. VBA-PW解除コードの紹介（※コピペでOK）</a></p>
        <p>&nbsp;&nbsp; <a href="#2-2._VBA-紹介コードの使用方法">2-2. VBA-紹介コードの使用方法</a></p>
        <p>&nbsp;</p>
        <p><a href="#ライセンス">ライセンス</a></p>
        <p><a href="#参考">参考</a></p>
      </nav>
    </td>
  </tr>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>

<section>
	<h2> <a name="1._VBA-マクロのパスワード解除とは？（VBAProjectパスワードのこと）">1. VBA-マクロのパスワード解除とは？（VBAProjectパスワードのこと）</a></h2>
  <p> マクロのパスワード解除とは、「VBAProject パスワード」の解除って意味です。</p>
  <p> &nbsp;</p>
  <p> 下図で赤枠で囲ってあるパスワード解除方法について本記事では触れていきます。</p>
      <p> <a href="vba_password_unlocked/img39.jpg" target="_blank">
      <img alt="VBA パスワード入力画面" class="border_with_drop-shadow" src="vba_password_unlocked/img39.jpg" width="800"></a></p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>
</section>

<p> &nbsp;</p>

<section>
  <h2> <a name="2._方法１">2. 方法１</a></h2>
  <h3> <a name="2-1._VBA-PW解除コードの紹介（※コピペでOK）">2-1. VBA-PW解除コードの紹介（※コピペでOK）</a></h3>
  <p> EXCELのバージョンによって、使用するコードが若干異なります。</p>
  <p> &nbsp;</p>
  <table style="width: 300px" class="border-collapse">
    <tr>
      <td>
      違う箇所は、変数の部分ですね。<br>
      64bit版だとlongptrという変数を使用しています。
      </td>
    </tr>
  </table>
  <p> &nbsp;</p>
  
  <p> Excel 32bit 版はこちら</p>

<pre class="prettyprint linenums lang-vb"><code>Public Const PAGE_EXECUTE_READWRITE = &amp;H40
 
Public Declare PtrSafe Sub MoveMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As LongPtr, Source As LongPtr, ByVal Length As LongPtr)
Public Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As LongPtr, ByVal dwSize As LongPtr, ByVal flNewProtect As LongPtr, lpflOldProtect As LongPtr) As LongPtr
Public Declare PtrSafe Function GetModuleHandleA Lib &quot;kernel32&quot; (ByVal lpModuleName As String) As LongPtr
Public Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr
Public Declare PtrSafe Function DialogBoxParam Lib &quot;user32&quot; Alias &quot;DialogBoxParamA&quot; (ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
Dim HookBytes(0 To 5) As Byte
Dim OriginBytes(0 To 5) As Byte
Dim projectFunction As <span class="auto-style2">Long</span>
Dim Flag As Boolean
 
Public Function GetPtr(ByVal Value As LongPtr) As LongPtr
  GetPtr = Value
End Function
 
Public Sub RecoverBytes()
  If Flag Then MoveMemory ByVal projectFunction, ByVal VarPtr(OriginBytes(0)), 6
End Sub

Public Function MyDialogBoxParamater(ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
  If pTemplateName = 4070 Then
    MyDialogBoxParamater = 1
  Else
    RecoverBytes
    MyDialogBoxParamater = MyDialogBoxParamater(hInstance, pTemplateName, hWndParent, lpDialogFunc, dwInitParam)
    HookFlag
  End If
End Function
 
Public Function HookFlag() As Boolean
  Dim TmpBytes(0 To 5) As Byte
  Dim p As <span class="auto-style2">Long</span>
  Dim OriginProtect As <span class="auto-style2">Long</span>
 
  HookFlag = False
  projectFunction = GetProcAddress(GetModuleHandleA(&quot;user32.dll&quot;), &quot;DialogBoxParamA&quot;)
  If VirtualProtect(ByVal projectFunction, 6, PAGE_EXECUTE_READWRITE, OriginProtect) &lt;&gt; 0 Then
    MoveMemory ByVal VarPtr(TmpBytes(0)), ByVal projectFunction, 6
    If TmpBytes(0) &lt;&gt; &amp;H68 Then
      MoveMemory ByVal VarPtr(OriginBytes(0)), ByVal projectFunction, 6
      p = GetPtr(AddressOf MyDialogBoxParamater)
      HookBytes(0) = &amp;H68
      MoveMemory ByVal VarPtr(HookBytes(1)), ByVal VarPtr(p), 4
      HookBytes(5) = &amp;HC3
      MoveMemory ByVal projectFunction, ByVal VarPtr(HookBytes(0)), 6
      Flag = True
      HookFlag = True
    End If
  End If
End Function
 
 
Sub VBAProjectパスワード解除()
  If HookFlag Then
    MsgBox &quot;VBA Project を解除しました。&quot;, vbInformation, &quot;成功しました。&quot;
  End If
End Sub</code></pre>

<p> &nbsp;</p>

<p> Excel 64bit 版はこちら</p>

<pre class="prettyprint linenums lang-vb"><code>Public Const PAGE_EXECUTE_READWRITE = &amp;H40
 
Public Declare PtrSafe Sub MoveMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (Destination As LongPtr, Source As LongPtr, ByVal Length As LongPtr)
Public Declare PtrSafe Function VirtualProtect Lib &quot;kernel32&quot; (lpAddress As LongPtr, ByVal dwSize As LongPtr, ByVal flNewProtect As LongPtr, lpflOldProtect As LongPtr) As LongPtr
Public Declare PtrSafe Function GetModuleHandleA Lib &quot;kernel32&quot; (ByVal lpModuleName As String) As LongPtr
Public Declare PtrSafe Function GetProcAddress Lib &quot;kernel32&quot; (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr
Public Declare PtrSafe Function DialogBoxParam Lib &quot;user32&quot; Alias &quot;DialogBoxParamA&quot; (ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
Dim HookBytes(0 To 5) As Byte
Dim OriginBytes(0 To 5) As Byte
Dim projectFunction As <span class="auto-style2">LongPtr</span>
Dim Flag As Boolean
 
Public Function GetPtr(ByVal Value As LongPtr) As LongPtr
  GetPtr = Value
End Function
 
Public Sub RecoverBytes()
  If Flag Then MoveMemory ByVal projectFunction, ByVal VarPtr(OriginBytes(0)), 6
End Sub

Public Function MyDialogBoxParamater(ByVal hInstance As LongPtr, ByVal pTemplateName As LongPtr, ByVal hWndParent As LongPtr, ByVal lpDialogFunc As LongPtr, ByVal dwInitParam As LongPtr) As Integer
  If pTemplateName = 4070 Then
    MyDialogBoxParamater = 1
  Else
    RecoverBytes
    MyDialogBoxParamater = MyDialogBoxParamater(hInstance, pTemplateName, hWndParent, lpDialogFunc, dwInitParam)
    HookFlag
  End If
End Function
 
Public Function HookFlag() As Boolean
  Dim TmpBytes(0 To 5) As Byte
  Dim p As <span class="auto-style2">LongPtr</span>
  Dim OriginProtect As <span class="auto-style2">LongPtr</span>
 
  HookFlag = False
  projectFunction = GetProcAddress(GetModuleHandleA(&quot;user32.dll&quot;), &quot;DialogBoxParamA&quot;)
  If VirtualProtect(ByVal projectFunction, 6, PAGE_EXECUTE_READWRITE, OriginProtect) &lt;&gt; 0 Then
    MoveMemory ByVal VarPtr(TmpBytes(0)), ByVal projectFunction, 6
    If TmpBytes(0) &lt;&gt; &amp;H68 Then
      MoveMemory ByVal VarPtr(OriginBytes(0)), ByVal projectFunction, 6
      p = GetPtr(AddressOf MyDialogBoxParamater)
      HookBytes(0) = &amp;H68
      MoveMemory ByVal VarPtr(HookBytes(1)), ByVal VarPtr(p), 4
      HookBytes(5) = &amp;HC3
      MoveMemory ByVal projectFunction, ByVal VarPtr(HookBytes(0)), 6
      Flag = True
      HookFlag = True
    End If
  End If
End Function
 
 
Sub VBAProjectパスワード解除()
  If HookFlag Then
    MsgBox &quot;VBA Project を解除しました。&quot;, vbInformation, &quot;成功しました。&quot;
  End If
End Sub</code></pre>

  <p> &nbsp;</p>
  <p> &nbsp;</p>
  <p> &nbsp;</p>

  <h3> <a name="2-2._VBA-紹介コードの使用方法">2-2. VBA-紹介コードの使用方法</a></h3>
  <p> 使い方は、以下の通り。</p>
  <p> &nbsp;</p>
  <ol>
    <li>新しいEXCELを開く（以下、Aファイルとする）</li>
    <li>マクロにPWが掛かったEXCELを開く（以下、Bファイルとする）</li>
    <li>Aファイル側にPW解除マクロコードをコピペ（適当な新規プロシージャに。）</li>
    <li>Aファイル側でPW解除コードを実行（実行するSub名：VBAProjectパスワード解除）</li>
    <li>Bファイル側のマクロPWが解除されている</li>
  </ol>
  <p>&nbsp;</p>
  <p><img alt="VBA概要" src="vba_password_unlocked/img13.jpg" width="1000"></p>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
  <p class="auto-style1"> 注意ポイント</p>
  <p>&nbsp;</p>
  <p> 尚、Bファイルを閉じてしまうとPWロックが復活してしまいますので、<br>もしPW自体を削除したい場合は、PWロック解除後に、<br>
  BファイルのVBE側で</p>
  <p> 「ツール」→「VBAProjectのプロパティ」</p>
  <p> から設定されたパスワードを削除しましょう。<br>そうすればPW復活はしなくなります。</p>
  <p> 具体的には、以下のキャプチャの通りの状態にしてあげましょう。</p>
  <p>&nbsp;</p>
  <p><a href="vba_password_unlocked/img3A.jpg" target="_blank">
  <img alt="VBA 実行後のパスワード解除手順" class="border_with_drop-shadow" src="vba_password_unlocked/img3A.jpg" width="800"></a></p>
  <p>&nbsp;</p>
</section>

<p>&nbsp;</p>

<section>
  <div class="status_warning">
    <div></div>
    <div>
      <p><strong>注意</strong></p>
      <p>[2022-09-16] 久し振りに上記の方法を試してみたところ、最後のパスワードを外すところで Excel 
      が再起動してしまいました。結果、私はパスワードを解除することができませんでした。何か間違えたか、または Microsoft がセキュリティ対策をしたのかもしれません。</p>
      <p>参考[5] に記載の方法を使うことでパスワード解除できたので、それぞれ試してみても良いかも。</p>
    </div>
  </div>
</section>

<p>&nbsp;</p>
<p>&nbsp;</p>

<section>
  <h2><a name="ライセンス">ライセンス</a></h2>
  <p>本ページの情報は、特記無い限り下記 MIT ライセンスで提供されます。</p>
  <table class="border-collapse" style="width: 600px; background-color: #F0F0F0; word-break: break-word;">
    <tr>
      <td>
        MIT License<br><br>

        Copyright (c) 2021  Kinoshita Hidetoshi<br><br>

        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:<br><br>

        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.<br><br>

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
      </td>
    </tr>
  </table>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
</section>

<p>
<br>

</p>

<section>
	<h2><a name="参考">参考</a></h2>
	<ul>
		<li>
      [1] 【EXCEL】VBA-マクロのパスワード解除方法【コード有】 (nkmrdai.com)<br>
      <a href="https://nkmrdai.com/vba-password-unrocked/" target="_blank">https://nkmrdai.com/vba-password-unrocked/</a></li>
    <li>
      [2] Excel 64Bit版 VBAマクロ パスワード解除方法 | ホームページ制作のサカエン Developer's Blog 
      (saka-en.com)<br>
      <a href="https://www.saka-en.com/office/excel-vba-password-unlock-64bit/" target="_blank">
      https://www.saka-en.com/office/excel-vba-password-unlock-64bit/</a></li>
    <li>
      [3] Excel VBAマクロ パスワード解除方法 | ホームページ制作のサカエン Developer&#39;s Blog (saka-en.com)<br>
      <a href="https://www.saka-en.com/office/excel-vba-password-unlock/" target="_blank">https://www.saka-en.com/office/excel-vba-password-unlock/</a></li>
    <li>
      [4] まるで魔法！！ 本当は教えたくない！？簡単ExcelVBAのプロジェクトロックをさらっと解除する方法 | 気楽生活 - OFFICE &amp; OUTDOOR - (tsurutoro.com)<br>
      <a href="https://tsurutoro.com/problem-solving/" target="_blank">https://tsurutoro.com/problem-solving/</a></li>
		<li>
      [5] Excel VBA（マクロ）のパスワードはバイナリエディタで解除できる | ホームページ制作のサカエン Developer's Blog 
      (saka-en.com)<br>
      <a href="https://www.saka-en.com/office/vba-password-unlock-binary/" target="_blank">
      https://www.saka-en.com/office/vba-password-unlock-binary/</a></li>
	</ul>
</section>

<p>&nbsp;</p>

<hr>

<p style="margin-bottom:5px">&nbsp;</p>

<section>
	<h2 style="margin-bottom:5px">記載</h2>
	<table>
	  <tr>
	    <td class="td_history_date">2022-09-16</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">説明追記</td>
	  </tr>
	  <tr>
	    <td class="td_history_date">2021-09-09</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">新規作成 </td>
	  </tr>
	</table>
</section>

<p>&nbsp;</p>

<section>
<p><a href="../index.html" target="_parent">Programming Items トップページ</a></p>
<p><a href="../privacy_policy.html">プライバシーポリシー</a></p>
</section>

<p>&nbsp;</p>

<footer>
	<p><small>&copy; copyright 2021 木下英俊</small></p>
</footer>

</body>
</html>
