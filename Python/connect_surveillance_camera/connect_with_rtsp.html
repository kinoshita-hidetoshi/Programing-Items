<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="木下英俊">
  <meta name="description" content="木下英俊が自身のためにプログラムメモを残すことを目的に作成したページです。">
  <meta name="keywords" content="">
  <!-- キャッシュ無効化 -->
  <meta http-equiv="Cache-Control" content="no-cache">
	
  <title>RTSPで画像を取得する</title>
	
  <!-- CSS -->
  <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../../design.css" type="text/css">
  
  <!-- Start for 'google-code-prettify' -->
  <link href="../../prettify.css" rel="stylesheet" type="text/css">
  <script src="../../prettify.js" type="text/javascript"></script>
  <!-- End for 'google-code-prettify' -->

  <style type="text/css">
  .auto-style1 {
    background-color: #FFFF00;
  }
  </style>

</head>

<body onload="prettyPrint();">

<h1>RTSP で画像を取得する</h1>

<p> i-PRO の監視カメラ i-PRO mini (WV-S7130W) から RTSP(H.264/H.265) で映像取得して遊んでみます。</p>

<p>&nbsp;</p>
<table style="border: 1px solid #808080; width: 100%; max-width:800px; background-color: #F0F0F0;">
  <tr>
    <td>
      <nav>
        <h2> 目次</h2>
        <p>
        <a href="#1._CGI_表記仕様">1. CGI 表記仕様</a><br>
        <a href="#2._Python_で_i-PRO_mini_(WV-S7130W)_と接続して映像を表示してみる">2. Python で i-PRO mini (WV-S7130W) と接続して映像を表示してみる</a><br>
        <a href="#3.プログラムを改善する_">3. プログラムを改善する</a><br>
        <br>
        <a href="#参考">参考</a><br>
        </p>
      </nav>
    </td>
  </tr>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>

<section>
	<h2> <a name="1._CGI_表記仕様">1. CGI 表記仕様</a></h2>
	<h4>[概要]</h4>
	<p> RTSP で接続するための表記を以下に記載します。</p>
    <p>&nbsp;</p>
    <h3>i-PRO (Panasonic) 従来 model</h3>
    <p><span class="cpp-source">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/h264/stream_1</span></p>
    <p>&nbsp;</p>
    <p>(例) <span class="cpp-source">
    rtsp://admin:password@192.168.0.10/MediaInput/h264/stream_1</span></p>
    <p>&nbsp;</p>
    <h3>&nbsp;</h3>
    <h3>i-PRO H265 model</h3>
    <p><span class="cpp-source">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1</span></p>
    <p>&nbsp;</p>
    <p>(例) <span class="cpp-source">
    rtsp://admin:password@192.168.0.10/MediaInput/stream_1</span></p>
    <p>&nbsp;</p>
    
    <h3>i-PRO H265モデル CGI仕様書からの抜粋</h3>
    
    <p>10.6. 汎用ﾋﾞｭｰｱでH.265を見る
以下のURLを使用することで、H.265配信を配信することができます。<br>（圧縮方式をH.265に設定する必要があります。）</p>
    <p>&nbsp;</p>
    <table class="border-collapse" style="width: 1000px">
      <tr>
        <td class="standard_table"><strong>ストリーム(1)</strong></td>
        <td class="standard_table">
        rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(2)</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_2 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(3)</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_3 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(4)</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_4 </td>
      </tr>
      </table>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    
    <h3>マルチセンサーカメラ（X8570 / S8530）</h3>
    
    <table class="border-collapse" style="width: 1000px">
      <tr>
        <td class="standard_table"><strong>ストリーム(1) Ch1 (Camera1)/</strong></td>
        <td class="standard_table">
        rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1<br>rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1/ch_1</td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(2) Ch1 (Camera1)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_2<br>rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_2/ch_1 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(1) Ch2 (Camera2)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1/ch_2 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(2) Ch2 (Camera2)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_2/ch_2 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(1) Ch3 (Camera3)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1/ch_3 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(2) Ch3 (Camera3)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_2/ch_3 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(1) Ch4 (Camera4)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_1/ch_4 </td>
      </tr>
      <tr>
        <td class="standard_table"><strong>ストリーム(2) Ch4 (Camera4)/</strong></td>
        <td class="standard_table">rtsp://&lt;user-id&gt;:&lt;user-password&gt;@&lt;カメラのIPアドレス&gt;/MediaInput/stream_2/ch_4 </td>
      </tr>
      </table>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
</section>
<p>&nbsp;</p>

<section>
	<h2> <a name="2._Python_で_i-PRO_mini_(WV-S7130W)_と接続して映像を表示してみる">2. Python で i-PRO mini (WV-S7130W) と接続して映像を表示してみる</a></h2>
	<h4>[概要]</h4>
    <p>とりあえず映像を取得してPC画面に表示するまでをやってみます。</p>
	<p> &nbsp;</p>
	
	<h4>[環境]</h4>
	<table>
	<tbody>
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>言語 :</td>
	    <td>Python,</td>
	    <td>3.8.10 </td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>OS :</td>
	    <td>Ubuntu(WSL),</td>
	    <td>20.04</td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
	</tbody>
	</table>
	
	<p>&nbsp;</p>
  <p>[プログラムソース &quot;connect_with_rtsp_1.py&quot;]</p>
  
	<pre class="prettyprint linenums">
'''
[abstract]
    i-PRO mini (WV-S7130W) と接続して映像を表示してみる 
[library install]
 &nbsp; &nbsp;pip install opencv-python 
'''

import cv2
user_id = "user-id" 
user_pw = "password" 
host = "192.168.0.10" 
cap = cv2.VideoCapture(f"rtsp://{user_id}:{user_pw}@{host}/MediaInput/stream1")

while(True):
    try:
        ret, frame = cap.read()
        if ret == True:
            frame2 = cv2.resize(frame, (1280, 760))
            cv2.imshow('VIDEO', frame2)

        # コンソール上で ctrl-c を押すとプログラムを終了する。
        # GUI 上で ctrl-c してもプログラムを終了できない。
        cv2.waitKey(1)

    except KeyboardInterrupt:
        print("KeyboardInterrupt")
        break

cap.release()
cv2.destroyAllWindows()</pre>
</section>
	
<br>

<p>&nbsp;</p>
<p>&nbsp;<br>

</p>


<section>
  <h2><a name="3.プログラムを改善する_">3.プログラムを改善する </a></h2>
	<h4>[概要]</h4>
  <p>今作成したプログラムはとても簡単に作成できましたが、いろいろと課題がありました。<br>とりあえず下記３つの課題を解決してみます。</p>
  <p>&nbsp;</p>
  <ol>
    <li>ウィンドウ初期位置を指定</li>
    <li>&nbsp;ウィンドウ終了ボタン[X] でプログラム終了</li>
    <li>"z" キー押下でプログラム終了</li>
  </ol>
    <p>&nbsp;</p>
	<p> &nbsp;</p>
	
	<h4>[環境]</h4>
	<table>
	<tbody>
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>言語 :</td>
	    <td>Python,</td>
	    <td>3.8.10 </td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>OS :</td>
	    <td>Ubuntu(WSL),</td>
	    <td>20.04</td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
	</tbody>
	</table>
	
	<p>&nbsp;</p>
  <p>&nbsp;</p>
  <p>[プログラムソース &quot;connect_with_rtsp_2.py&quot;]</p>
	<pre class="prettyprint linenums">
'''
[abstract]
    i-PRO mini (WV-S7130W) と接続して映像を表示してみる

[library install]
    pip install opencv-python
'''

import cv2

user_id = "user-id" 
user_pw = "password" 
host = "192.168.0.10" 
winname = "VIDEO"

cap = cv2.VideoCapture(f"rtsp://{user_id}:{user_pw}@{host}/MediaInput/stream_1")

<span class="auto-style1">#</span>
<span class="auto-style1">windowInitialized = False</span>

<span class="auto-style1"># Exception 定義</span>
<span class="auto-style1">BackendError = type('BackendError', (Exception,), {})</span>

<span class="auto-style1">'''</span>
<span class="auto-style1">[Abstract]</span>
<span class="auto-style1">    対象ウィンドウが存在するかを確認する。</span>
<span class="auto-style1">[Param]</span>
<span class="auto-style1">    winname :       ウィンドウタイトル</span>
<span class="auto-style1">[Return]</span>
<span class="auto-style1">    True :          対象ウィンドウは存在する</span>
<span class="auto-style1">    False :         対象ウィンドウは存在しない</span>
<span class="auto-style1">[Exception]</span>
<span class="auto-style1">    BackendError :  バックエンドで使用している Qt でエラー発生</span>
<span class="auto-style1">'''</span>
<span class="auto-style1">def IsWindowVisible(winname):</span>
<span class="auto-style1">    try:</span>
<span class="auto-style1">        ret = cv2.getWindowProperty(winname, cv2.WND_PROP_VISIBLE)</span>
<span class="auto-style1">        if ret == -1:</span>
<span class="auto-style1">            raise BackendError('Use Qt as backend to check whether window is visible or not.')</span>

<span class="auto-style1">        return bool(ret)</span>

<span class="auto-style1">    except cv2.error:</span>
<span class="auto-style1">        return False</span>


while(True):
    try:
        ret, frame = cap.read()
        if ret == True:
            frame2 = cv2.resize(frame, (1280, 760))
            cv2.imshow(winname, frame2)

<span class="auto-style1">            if windowInitialized==False:</span>
<span class="auto-style1">                # ウィンドウ表示位置が安定しないので、最初の起動時のみ表示場所を指定</span>
<span class="auto-style1">                cv2.moveWindow(winname, 100, 100)</span>
<span class="auto-style1">                windowInitialized = True</span>

<span class="auto-style1">        # "z" キーを押されていたら終了</span>
<span class="auto-style1">        k = cv2.waitKey(1)</span>
<span class="auto-style1">        if k == ord("z"):</span>
<span class="auto-style1">            break</span>
        
<span class="auto-style1">        # 指定ウィンドウが無かったら終了</span>
<span class="auto-style1">        if not IsWindowVisible(winname):</span>
<span class="auto-style1">            break</span>

    except KeyboardInterrupt:
        print("KeyboardInterrupt")
        break

cap.release()
cv2.destroyAllWindows()</pre>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
</section>


<section>
	<h2><a name="参考">参考</a></h2>
	<ul>
		<li>[python] ネットワークカメラの画像を RTSP で取得して表示・保存 - へっぽこプログラマーの備忘録 
        (kuttsun.blogspot.com)<br>
        <a href="https://kuttsun.blogspot.com/2021/08/python-rtsp.html" target="_blank">
        https://kuttsun.blogspot.com/2021/08/python-rtsp.html</a></li>
        <li>ネットワークカメラCGIコマンドインターフェース仕様書　統合版<br>
        <a href="https://sol.panasonic.biz/security/cgi-bin/ipro/download/tbookmarka_m.cgi?m=%20&amp;mm=2012100910461872" target="_blank">
        https://sol.panasonic.biz/security/cgi-bin/ipro/download/tbookmarka_m.cgi?m=%20&amp;mm=2012100910461872</a></li>
	</ul>
</section>

<p>&nbsp;</p>
<p>&nbsp;</p>

<hr>

<p>&nbsp;</p>

<section>
	<h2 style="margin-bottom:5px">記載</h2>
	<table>
	  <tr>
	    <td class="td_history_date">2022-03-26</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">３章を追加</td>
	  </tr>
	  <tr>
	    <td class="td_history_date">2022-03-19</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">新規作成 </td>
	  </tr>
	</table>
</section>

<p>&nbsp;</p>

<footer>
	<p><small>&copy; copyright 2022 木下英俊</small></p>
</footer>

</body>
</html>
