<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="木下英俊">
  <meta name="description" content="木下英俊が自身のためにプログラムメモを残すことを目的に作成したページです。">
  <meta name="keywords" content="">
  <!-- キャッシュ無効化 -->
  <meta http-equiv="Cache-Control" content="no-cache">
	
  <title>JPEGで画像を取得する</title>
	
  <!-- CSS -->
  <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
	<link rel="stylesheet" href="../../design.css" type="text/css">
  
	<!-- Start for 'google-code-prettify' -->
	<link href="../../prettify/styles/desert.css" rel="stylesheet" type="text/css">
	<script src="../../prettify/prettify.js" type="text/javascript"></script>
	<!-- End for 'google-code-prettify' -->	

  <style type="text/css">
  .auto-style1 {
    background-color: #484800;
  }
  </style>

</head>

<body onload="prettyPrint();">
	
<h1>JPEG で画像を取得する</h1>

<p> i-PRO の監視カメラ i-PRO mini (WV-S7130W) を入手したので、JPEG 形式で映像取得して遊んでみます。</p>
<p> &nbsp;</p>
<p> 製品紹介ページ： </p>
<ul>
  <li><a href="https://cwc.i-pro.com/pages/i-pro-mini-lp" target="_blank">
  i-pro-mini-lp</a></li>
  <li>
  <a href="https://cwc.i-pro.com/collections/camera/products/wv-s7130wux" target="_blank">
  i-PRO mini 無線LANモデル WV-S7130WUX</a></li>
</ul>
<p> &nbsp;</p>
<p> <img alt="" src="connect_with_jpeg/imgE.jpg"></p>

<p>&nbsp;</p>
<table style="border: 1px solid #808080; width: 100%; max-width:800px; background-color: #F0F0F0;">
  <tr>
    <td>
      <nav>
        <h2> 目次</h2>
        <p>
        <a href="#1._Python_で_i-PRO_mini_(WV-S7130W)_と接続して映像を表示してみる">1. Python で i-PRO mini (WV-S7130W) と接続して映像を表示してみる</a><br>
        <a href="#2.プログラムを改善する_">2. プログラムを改善する</a><br>
        <a href="#3. OpenCV で顔認識を加えてみる">3. OpenCV で顔認識を加えてみる</a><br>
        <br>
        <a href="#参考">参考</a><br>
        </p>
      </nav>
    </td>
  </tr>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>

<section>
	<h2> <a name="1._Python_で_i-PRO_mini_(WV-S7130W)_と接続して映像を表示してみる">1. Python で 
    i-PRO mini (WV-S7130W) と接続して映像を表示してみる</a></h2>
	<h4>[概要]</h4>
	<p> とりあえず映像を取得してPC画面に表示するまでをやってみます。</p>
    <p> &nbsp;</p>
	
	<h4>[評価環境]</h4>
	<table>
	<tbody>
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>言語 :</td>
	    <td>Python,</td>
	    <td>3.8.10 </td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>OS :</td>
	    <td>Ubuntu(WSL),</td>
	    <td>20.04</td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
	</tbody>
	</table>
	
	<p> &nbsp;</p>
	<p> &nbsp;</p>
	
	<p>[プログラムソース &quot;connect_with_jpeg_1.py&quot;]</p>
	<pre class="prettyprint linenums lang-py">
 '''
[abstract]
    i-PRO mini (WV-S7130W) と接続して映像を表示してみる

[library install]
    pip install opencv-python
    pip install Pillow
    pip install numpy
    pip install requests
'''

import requests
from requests.auth import HTTPDigestAuth

import io
from PIL import Image
import numpy as np
import cv2

user_id = "user-id"         # ユーザーID
user_pw = "password"        # ユーザーパスワード
host = "192.168.2.126"      # カメラのIPアドレス
resolution = 1920           # 解像度

# URL
url = f"http://{host}/cgi-bin/camera?resolution={resolution}"

while True:

    # 画像の取得
    rs = requests.get(url, auth=HTTPDigestAuth(user_id, user_pw))

    # PIL 形式で作成
    img_bin = io.BytesIO(rs.content)
    img_pil = Image.open(img_bin)

    # PIL 形式を OpenCV 形式へ変換
    img_np  = np.asarray(img_pil)
    img1 = cv2.cvtColor(img_np, cv2.COLOR_RGB2BGR)

    # リサイズ
    img2 = cv2.resize(img1, (1280, 760))

    # 映像表示
    cv2.imshow('VIDEO', img2)
    cv2.waitKey(1)</pre>
    <p>&nbsp;</p>
    <p>補足説明</p>
    <ul>
      <li>resolution :<br>任意の数字を書けそうに見えますが、カメラ側で設定されている解像度から選択する必要があります。<br>
      一致する値が無い場合はカメラ側設定のデフォルト値が採用されます。<br>こういう仕様みたいです</li>
    </ul>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
</section>



<section>
  <h2><a name="2.プログラムを改善する_">2.プログラムを改善する </a></h2>
	<h4>[概要]</h4>
  <p>前章で作成したプログラムはとても簡単に作成できましたが、いろいろと課題がありました。<br>とりあえず下記３つの課題を解決してみます。</p>
  <p>&nbsp;</p>
  <p>課題１<br>プログラムを起動するたびにウィンドウ位置が変わる。場合によっては画面外へ表示する場合もあって不便。<br>
  適当に画面内に収まる場所に表示してほしい。<br>⇨ 指定する場所にウィンドウを表示するようにします。</p>
  <p>&nbsp;</p>
  <p>課題２<br>プログラムを終了するのが大変。<br>ウィンドウ右上の×を押すとウィンドウがいったん消えるが、すぐに再表示されて終われない。<br>⇨ 
  ウィンドウ右上の✕ボタンでプログラムを終了できるようにします。</p>
  <p>&nbsp;</p>
  <p>課題３<br>同様に、任意のキー入力でプログラムを終了できるとうれしい。<br>⇨ "z" キー押下でプログラムを終了できるようにします。</p>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
	<p> &nbsp;</p>
	
	<h4>[評価環境]</h4>
	<table>
	<tbody>
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>言語 :</td>
	    <td>Python,</td>
	    <td>3.8.10 </td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>OS :</td>
	    <td>Ubuntu(WSL),</td>
	    <td>20.04</td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
	</tbody>
	</table>
	
	<p>&nbsp;</p>
  <p>&nbsp;</p>
  <p>[プログラムソース &quot;connect_with_jpeg_2.py&quot;]</p>
	<pre class="prettyprint linenums lang-py">
'''
[abstract]
    i-PRO mini (WV-S7130W) と接続して映像を表示してみる

[library install]
    pip install opencv-python
    pip install requests
    pip install Pillow

[OpenCV]
    下記URLからファイル "haarcascade_frontalface_alt2.xml" を入手すること
    https://github.com/opencv/opencv/tree/master/data/haarcascades
'''

import requests
from requests.auth import HTTPDigestAuth

import io
from PIL import Image
import numpy as np
import cv2

user_id = "user-id"         # ユーザーID
user_pw = "password"        # ユーザーパスワード
host = "192.168.2.126"      # カメラのIPアドレス
resolution = 1920           # 解像度
winname = "VIDEO"

# URL
url = f"http://{host}/cgi-bin/camera?resolution={resolution}"

<span class="auto-style1">#</span>
<span class="auto-style1">initialized = False</span>

<span class="auto-style1"># Exception 定義</span>
<span class="auto-style1">BackendError = type('BackendError', (Exception,), {})</span>

<span class="auto-style1">'''</span>
<span class="auto-style1">[Abstract]</span>
<span class="auto-style1">    対象ウィンドウが存在するかを確認する。</span>
<span class="auto-style1">[Param]</span>
<span class="auto-style1">    winname :       ウィンドウタイトル</span>
<span class="auto-style1">[Return]</span>
<span class="auto-style1">    True :          対象ウィンドウは存在する</span>
<span class="auto-style1">    False :         対象ウィンドウは存在しない</span>
<span class="auto-style1">[Exception]</span>
<span class="auto-style1">    BackendError :  バックエンドで使用している Qt でエラー発生</span>
<span class="auto-style1">'''</span>
<span class="auto-style1">def IsWindowVisible(winname):</span>
<span class="auto-style1">    try:</span>
<span class="auto-style1">        ret = cv2.getWindowProperty(winname, cv2.WND_PROP_VISIBLE)</span>
<span class="auto-style1">        if ret == -1:</span>
<span class="auto-style1">            raise BackendError('Use Qt as backend to check whether window is visible or not.')</span>

<span class="auto-style1">        return bool(ret)</span>

<span class="auto-style1">    except cv2.error:</span>
<span class="auto-style1">        return False</span>



while True:

    # 画像の取得
    rs = requests.get(url, auth=HTTPDigestAuth(user_id, user_pw))

    # PIL 形式で作成
    img_bin = io.BytesIO(rs.content)
    img_pil = Image.open(img_bin)

    # PIL 形式を OpenCV 形式へ変換
    img_np  = np.asarray(img_pil)
    img1 = cv2.cvtColor(img_np, cv2.COLOR_RGB2BGR)

    # リサイズ
    img2 = cv2.resize(img1, (1280, 760))

    # 映像表示
    cv2.imshow(winname, img2)

<span class="auto-style1">    if initialized==False:</span>
<span class="auto-style1">        # ウィンドウ表示位置が安定しないので、最初の起動時のみ表示場所を指定</span>
<span class="auto-style1">        cv2.moveWindow(winname, 100, 100)</span>
<span class="auto-style1">        initialized = True</span>
        
<span class="auto-style1">    # "z" キーを押されていたら終了</span>
<span class="auto-style1">    k = cv2.waitKey(1)</span>
<span class="auto-style1">    if k == ord("z"):</span>
<span class="auto-style1">        break</span>

<span class="auto-style1">    # 指定ウィンドウが無かったら終了</span>
<span class="auto-style1">    if not IsWindowVisible(winname):</span>
<span class="auto-style1">        break</span></pre>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
</section>


<section>
<h2><a name="3. OpenCV で顔認識を加えてみる">3. OpenCV で顔認識を加えてみる</a></h2>
	<h4>[概要]</h4>
	<p>OpenCV を使って顔認識を行って、見つけた顔部分に赤枠を描画してみます。&nbsp;</p>
  <p>&nbsp;</p>
	
	<h4>[環境]</h4>
	<table>
	<tbody>
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>言語 :</td>
	    <td>Python,</td>
	    <td>3.8.10 </td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
		
	  <tr>
	    <td>OS :</td>
	    <td>Ubuntu(WSL),</td>
	    <td>20.04</td>
	  </tr>
		
	  <tr>
	    <td class="td_separate" colspan="3"></td>
	  </tr>
	</tbody>
	</table>
	
	<p> &nbsp;</p>
	<p> &nbsp;</p>
	
	<p>[プログラムソース &quot;connect_with_jpeg_3.py&quot;]</p>
	<pre class="prettyprint linenums lang-py">
'''
[abstract]
    i-PRO mini (WV-S7130W) と接続して映像を表示してみる

[library install]
    pip install opencv-python
    pip install requests
    pip install Pillow

[OpenCV]
    下記URLからファイル "haarcascade_frontalface_alt2.xml" を入手すること
    https://github.com/opencv/opencv/tree/master/data/haarcascades
'''

import requests
from requests.auth import HTTPDigestAuth

import io
from PIL import Image
import numpy as np
import cv2

user_id = "user-id"         # ユーザーID
user_pw = "password"        # ユーザーパスワード
host = "192.168.2.126"      # カメラのIPアドレス
resolution = 1920           # 解像度
winname = "VIDEO"

# URL
url = f"http://{host}/cgi-bin/camera?resolution={resolution}"

<span class="auto-style1"># 顔を識別するためのファイル</span>
<span class="auto-style1">cascade_file = "haarcascade_frontalface_alt2.xml"       # 顔</span>
<span class="auto-style1">#cascade_file = "haarcascade_eye.xml"                   # 目？</span>
<span class="auto-style1">#cascade_file = "haarcascade_eye_tree_eyeglasses.xml"   # 目？</span>
<span class="auto-style1">cascade = cv2.CascadeClassifier(cascade_file)</span>

#
initialized = False

# Exception 定義
BackendError = type('BackendError', (Exception,), {})

'''
[Abstract]
    対象ウィンドウが存在するかを確認する。
[Param]
    winname :       ウィンドウタイトル
[Return]
    True :          対象ウィンドウは存在する
    False :         対象ウィンドウは存在しない
[Exception]
    BackendError :  バックエンドで使用している Qt でエラー発生
'''
def IsWindowVisible(winname):
    try:
        ret = cv2.getWindowProperty(winname, cv2.WND_PROP_VISIBLE)
        if ret == -1:
            raise BackendError('Use Qt as backend to check whether window is visible or not.')

        return bool(ret)

    except cv2.error:
        return False



while True:

    # 画像の取得
    rs = requests.get(url, auth=HTTPDigestAuth(user_id, user_pw))

    # PIL 形式で作成
    img_bin = io.BytesIO(rs.content)
    img_pil = Image.open(img_bin)

    # PIL 形式を OpenCV 形式へ変換
    img_np  = np.asarray(img_pil)
    img1 = cv2.cvtColor(img_np, cv2.COLOR_RGB2BGR)

<span class="auto-style1">    # 顔検出のためにグレイスケール画像に変換</span>
<span class="auto-style1">    img_gray = cv2.cvtColor(img1, cv2.COLOR_BGR2GRAY)</span>

<span class="auto-style1">    # 検出した顔の位置情報を取得</span>
<span class="auto-style1">    face_list = cascade.detectMultiScale(img_gray, minSize=(100, 100))</span>

<span class="auto-style1">    # 顔を検出したらループ処理を終了</span>
<span class="auto-style1">    if len(face_list) != 0:</span>
<span class="auto-style1">        #print("Find face.")</span>

<span class="auto-style1">        for (pos_x, pos_y, w, h) in face_list:</span>
<span class="auto-style1">            print(f"pos_x = {pos_x}, pos_y = {pos_y}, w = {w}, h = {h}")</span>
<span class="auto-style1">            cv2.rectangle(img1, (pos_x, pos_y), (pos_x + w, pos_y + h), (0,0,255), thickness=5)</span>

    # リサイズ
    img2 = cv2.resize(img1, (1280, 760))

    # 映像表示
    cv2.imshow(winname, img2)

    if initialized==False:
        # ウィンドウ表示位置が安定しないので、最初の起動時のみ表示場所を指定
        cv2.moveWindow(winname, 100, 100)
        initialized = True
        
    # "z" キーを押されていたら終了
    k = cv2.waitKey(1)
    if k == ord("z"):
        break

    # 指定ウィンドウが無かったら終了
    if not IsWindowVisible(winname):
        break</pre>
  <p>&nbsp;</p>

<p>&nbsp;</p>
  <p>&nbsp;</p>
  <p><img alt="" src="connect_with_jpeg/img57.jpg" width="800px"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>

</section>

<section>
	<h2><a name="参考">参考</a></h2>
	<ul>
		<li>Panasonic製ネットワークカメラの画像を取得して顔検出をしてみる - Qiita<br>
        <a href="https://qiita.com/mix_dvd/items/a0bdbe0ba628d5282639" target="_blank">
        https://qiita.com/mix_dvd/items/a0bdbe0ba628d5282639</a></li>
        <li>ネットワークカメラCGIコマンドインターフェース仕様書　統合版<br>
        <a href="https://sol.panasonic.biz/security/cgi-bin/ipro/download/tbookmarka_m.cgi?m=%20&amp;mm=2012100910461872" target="_blank">
        https://sol.panasonic.biz/security/cgi-bin/ipro/download/tbookmarka_m.cgi?m=%20&amp;mm=2012100910461872</a></li>
	</ul>
    <p>&nbsp;</p>
</section>

<p>&nbsp;</p>

<hr>

<p>&nbsp;</p>

<section>
	<h2 style="margin-bottom:5px">記載</h2>
	<table>
	  <tr>
	    <td class="td_history_date">2022-03-26</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">２章を挿入</td>
	  </tr>
	  <tr>
	    <td class="td_history_date">2022-03-19</td>
	    <td class="td_history_separator">-</td>
	    <td class="td_history">新規作成 </td>
	  </tr>
	</table>
</section>

<p>&nbsp;</p>

<footer>
	<p><small>&copy; copyright 2022 木下英俊</small></p>
</footer>

</body>
</html>
